<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Cuadrantes - V3.7 (Historial y UI Final)</title>
    <style>
        /* --- ESTILOS BASE Y LAYOUT --- */
        :root {
            /* Modo Claro */
            --bg-color: #f0f4f8;
            --container-bg: white;
            --panel-bg: #e6f7ff;
            --panel-border: #b3e5fc;
            --sub-panel-bg: white;
            --primary-color: #0077b6;
            --primary-light: #4fbcdb;
            --secondary-color: #f39c12;
            --text-color: #333;
            --sub-text-color: #666;
            --border-color: #ccc;
            --table-header-bg: #34495e;
            --table-header-text: white;
            --shadow: 0 4px 25px rgba(0, 0, 0, 0.15);
            --card-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
            --menu-bg: #f5f5f5;
            --menu-border: #ddd;

            /* Botones */
            --btn-primary-bg: var(--primary-color);
            --btn-primary-text: white;
            --btn-secondary-bg: #f0f0f0;
            --btn-secondary-text: #333;
            --btn-danger-bg: #e74c3c;
            --btn-danger-text: white;
            --btn-hover-bg: #005f96;
            --btn-success-bg: #2ecc71;
            --btn-success-text: white;
        }

        /* --- ESTILOS MODO OSCURO --- */
        body.dark-mode {
            --bg-color: #1e1e2e;
            --container-bg: #292a3c;
            --panel-bg: #32354a;
            --panel-border: #4d4f68;
            --sub-panel-bg: #292a3c;
            --primary-color: #6ed3cf;
            --primary-light: #7bfffb;
            --secondary-color: #f9d85e;
            --text-color: #f0f0f0;
            --sub-text-color: #b0b0b0;
            --border-color: #4d4f68;
            --table-header-bg: #1e2029;
            --table-header-text: #6ed3cf;
            --shadow: 0 4px 25px rgba(0, 0, 0, 0.4);
            --card-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            --menu-bg: #222233;
            --menu-border: #4d4f68;

            --btn-primary-bg: var(--primary-color);
            --btn-primary-text: var(--table-header-bg);
            --btn-secondary-bg: #4d4f68;
            --btn-secondary-text: var(--text-color);
            --btn-danger-bg: #c0392b;
            --btn-danger-text: white;
            --btn-hover-bg: #4fbcdb;
            --btn-success-bg: #27ae60;
            --btn-success-text: white;
        }

        /* --- LAYOUT Y TIPOGRAF√çA --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            padding: 0;
            margin: 0;
            color: var(--text-color);
            transition: background-color 0.4s, color 0.4s;
            display: flex;
        }

        #sidebar {
            width: 300px;
            background: var(--menu-bg);
            color: var(--text-color);
            padding: 15px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 1000;
            overflow-y: auto;
            transform: translateX(-300px);
            transition: transform 0.3s ease-in-out;
            border-right: 1px solid var(--menu-border);
        }

        #sidebar.open {
            transform: translateX(0);
        }

        @media (min-width: 900px) {
            #sidebar {
                transform: translateX(0);
            }

            #main-content {
                margin-left: 300px;
            }

            #menu-toggle-btn {
                display: none;
            }
        }

        #main-content {
            flex-grow: 1;
            padding: 20px;
            transition: margin-left 0.3s ease-in-out;
            min-height: 100vh;
        }

        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 0 20px 0;
            border-bottom: 3px solid var(--primary-color);
        }

        h1 {
            color: var(--primary-color);
            margin: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--sub-panel-bg);
            padding: 30px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            margin-top: 20px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid var(--panel-border);
            border-radius: 8px;
            background: var(--panel-bg);
            transition: all 0.4s;
        }

        .section h2 {
            color: var(--primary-color);
            margin-top: 0;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--panel-border);
            margin-bottom: 15px;
        }

        /* --- CONTROLES DE FORMULARIO --- */
        .flex-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        input[type="number"],
        input[type="text"],
        input[type="date"],
        select,
        textarea {
            padding: 8px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            font-size: 0.9em;
            background-color: var(--sub-panel-bg);
            color: var(--text-color);
            transition: border-color 0.2s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        /* --- BOTONES EST√ÅNDAR --- */
        button {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s, color 0.2s, transform 0.1s;
        }

        .btn-primary {
            background-color: var(--btn-primary-bg);
            color: var(--btn-primary-text);
        }

        .btn-primary:hover {
            background-color: var(--btn-hover-bg);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: var(--btn-secondary-bg);
            color: var(--btn-secondary-text);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: var(--border-color);
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.8em;
        }

        /* --- BOTONES DE ICONO (NUEVOS) --- */
        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            padding: 5px;
            margin-left: 5px;
            color: var(--text-color);
            transition: color 0.2s, background-color 0.2s;
            border-radius: 4px;
        }

        .icon-btn:hover {
            background-color: var(--btn-secondary-bg);
            color: var(--primary-color);
        }

        .icon-btn-danger {
            color: var(--btn-danger-bg);
        }

        .icon-btn-danger:hover {
            color: white;
            background-color: var(--btn-danger-bg);
        }

        .icon-btn[disabled] {
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* --- ESTILOS DE LISTAS DE ENTIDADES --- */
        .group-header {
            font-weight: bold;
            color: var(--primary-color);
            margin-top: 15px;
            margin-bottom: 5px;
            padding: 5px 0;
            border-bottom: 1px dashed var(--panel-border);
        }

        .person-card,
        .dept-card {
            padding: 10px 15px;
            margin-bottom: 8px;
            border: 1px solid var(--panel-border);
            border-radius: 8px;
            background: var(--sub-panel-bg);
            box-shadow: var(--card-shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .member-badge {
            background-color: var(--primary-light);
            color: var(--table-header-bg);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.75em;
            margin-left: 5px;
            white-space: nowrap;
            vertical-align: middle;
            display: inline-block;
        }

        /* --- ESTILOS DE REGLAS CON MINIATURAS (NUEVO) --- */
        .rule-badge {
            display: inline-flex;
            align-items: center;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-right: 5px;
            margin-bottom: 5px;
            font-weight: 600;
            white-space: nowrap;
            cursor: default;
            vertical-align: middle;
        }

        .rule-badge-list {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-left: 10px;
        }

        .rule-restriction {
            background-color: #f7d7da;
            color: #c0392b;
            border: 1px solid #c0392b;
        }

        body.dark-mode .rule-restriction {
            background-color: #5c1b22;
            color: #ff8787;
            border: 1px solid #ff8787;
        }

        .rule-obligation {
            background-color: #d7f7e9;
            color: #27ae60;
            border: 1px solid #27ae60;
        }

        body.dark-mode .rule-obligation {
            background-color: #1a4d33;
            color: #87ffbe;
            border: 1px solid #87ffbe;
        }

        .rule-badge-remove {
            margin-left: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        /* --- ESTILOS DE TABS DE GENERACI√ìN (MEJORADOS) --- */
        .tabs {
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 5px;
        }

        .tab-button {
            padding: 8px 15px;
            border: 1px solid var(--panel-border);
            border-bottom: none;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            font-weight: bold;
            background-color: var(--panel-bg);
            /* Mismo color del fondo del panel */
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        .tab-button.active {
            background-color: var(--sub-panel-bg);
            /* Fondo blanco/oscuro para destacar */
            color: var(--primary-color);
            border-color: var(--panel-border);
            border-bottom: 1px solid var(--sub-panel-bg);
            /* Truco para que la l√≠nea no se vea */
            position: relative;
            z-index: 10;
        }

        /* --- ESTILOS DE SALTO PERSONALIZADO --- */
        #date-jump-config {
            margin-top: 15px;
            padding: 15px;
            border: 1px solid var(--panel-border);
            border-radius: 6px;
            background: var(--sub-panel-bg);
        }

        .jump-day-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .jump-day-selector label {
            display: flex;
            align-items: center;
            padding: 5px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            background-color: var(--bg-color);
            transition: background-color 0.2s, border-color 0.2s;
        }

        .jump-day-selector input[type="checkbox"] {
            margin-right: 5px;
        }

        .jump-day-selector input[type="checkbox"]:checked+span {
            font-weight: bold;
            color: var(--primary-color);
        }

        .jump-day-selector input[type="checkbox"]:checked {
            accent-color: var(--primary-color);
        }

        /* --- MODAL Y TABLA DE RESULTADOS (RESTO DE ESTILOS) --- */
        #config-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        #config-modal.open {
            display: flex;
        }

        #modal-content-wrapper {
            background: var(--container-bg);
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        #modal-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--text-color);
        }

        .modal-section {
            padding: 15px;
            border: 1px solid var(--panel-border);
            border-radius: 6px;
            margin-bottom: 15px;
            background: var(--panel-bg);
        }

        .modal-section h4 {
            color: var(--primary-color);
            margin-top: 0;
            border-bottom: 1px solid var(--panel-border);
            padding-bottom: 5px;
            margin-bottom: 10px;
        }

        /* Botones de Historial */
        #history-controls {
            display: flex;
            gap: 5px;
            margin-right: 15px;
        }

        /* Tabla de resultados */
        .quadrant-table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
        }

        #quadrant-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
            font-size: 0.9em;
            background: var(--sub-panel-bg);
        }

        #quadrant-table th,
        #quadrant-table td {
            padding: 10px;
            border: 1px solid var(--border-color);
            text-align: center;
            white-space: nowrap;
        }

        #quadrant-table th {
            background-color: var(--table-header-bg);
            color: var(--table-header-text);
            position: sticky;
            top: 0;
        }

        #quadrant-table .row-label {
            position: sticky;
            left: 0;
            z-index: 10;
            background: var(--table-header-bg);
            color: var(--table-header-text);
            font-weight: bold;
        }

        #quadrant-table tr:nth-child(odd) td {
            background-color: var(--bg-color);
        }

        #quadrant-table .conflict {
            background-color: #fbe7e7;
            color: #c0392b;
            font-weight: bold;
        }

        body.dark-mode #quadrant-table .conflict {
            background-color: #5c1b22;
            color: #ff8787;
        }

        .vacio {
            color: var(--sub-text-color);
            font-style: italic;
        }

        .day-break {
            border-top: 3px solid var(--primary-color) !important;
            font-weight: bold;
        }

        /* Tema de Modo Oscuro */
        .switch {
            position: relative;
            display: inline-block;
            width: 45px;
            height: 25px;
            margin-left: 10px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 25px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 19px;
            width: 19px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--primary-color);
        }

        input:checked+.slider:before {
            transform: translateX(20px);
        }

        .top-buttons {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Notificaci√≥n */
        #notification-bar {
            position: fixed;
            top: 0;
            right: 0;
            margin: 10px;
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 3000;
            transition: transform 0.3s ease-out, opacity 0.3s;
            transform: translateX(120%);
            opacity: 0;
        }

        #notification-bar.show {
            transform: translateX(0);
            opacity: 1;
        }

        #notification-bar.error {
            background-color: var(--btn-danger-bg);
        }

        #notification-bar.success {
            background-color: var(--btn-success-bg);
        }
    </style>
</head>

<body>

    <div id="notification-bar"></div>

    <div id="sidebar">
        <button id="menu-toggle-btn" onclick="toggleSidebar()">‚ò∞</button>
        <h3>Cuadrantes Guardados</h3>
        <ul id="saved-quadrants-list" class="sidebar-list">
        </ul>
    </div>

    <div id="main-content">
        <div class="header-bar">
            <h1>Generador de Cuadrantes V3.7</h1>
            <div class="top-buttons">
                <div id="history-controls">
                    <button class="btn-secondary btn-small" id="undo-btn" onclick="undo()" disabled
                        title="Deshacer (Ctrl+Z)">
                        ‚Ü©Ô∏è
                    </button>
                    <button class="btn-secondary btn-small" id="redo-btn" onclick="redo()" disabled
                        title="Rehacer (Ctrl+Y)">
                        ‚Ü™Ô∏è
                    </button>
                </div>
                <button class="btn-secondary" onclick="document.getElementById('upload-file').click()">‚¨ÜÔ∏è Cargar
                    (.json)</button>
                <input type="file" id="upload-file" accept=".json" style="display: none;"
                    onchange="uploadConfiguration(event)">
                <button class="btn-primary" onclick="saveQuadrant()">üíæ Guardar Cuadrante</button>

                <div class="theme-toggle">
                    <span style="font-weight: 600; font-size: 0.9em; color: var(--text-color);">Modo Oscuro</span>
                    <label class="switch">
                        <input type="checkbox" id="dark-mode-toggle" onchange="toggleDarkMode()">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <div class="container">

            <div class="section" id="person-section">
                <h2>üë§ Personas</h2>
                <div id="person-list" class="entity-list">
                </div>

                <div class="flex-row" style="margin-top: 20px;">
                    <input type="text" id="new-person-name" placeholder="Nombre de la nueva persona"
                        style="flex-grow: 1;">
                    <button class="btn-primary" onclick="openPersonConfigPanel()">+ A√±adir Persona</button>
                </div>

                <div style="margin-top: 25px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                    <div class="flex-row" style="justify-content: space-between;">
                        <label for="priority-mode">Prioridad de Asignaci√≥n:</label>
                        <select id="priority-mode" style="width: 250px;">
                            <option value="frecuencia">Priorizar Distribuci√≥n Frecuente</option>
                            <option value="pareja">Priorizar Diversidad de Parejas</option>
                        </select>
                    </div>

                    <div id="same-group-option" class="group-dependent-option flex-row"
                        style="justify-content: space-between; margin-top: 10px;">
                        <label for="same-group-only">Solo Personas del Mismo Grupo Juntas</label>
                        <input type="checkbox" id="same-group-only">
                    </div>
                </div>
            </div>

            <div class="section" id="department-slot-section">
                <h2>üè¢ Departamentos (Slots/Roles de Asignaci√≥n)</h2>

                <p style="font-size: 0.9em; color: var(--sub-text-color);">Cada departamento define un rol y se
                    convierte en una columna del cuadrante.</p>

                <div id="department-list" class="entity-list">
                </div>

                <div class="flex-row" style="margin-top: 20px;">
                    <input type="text" id="new-dept-name" placeholder="Nombre del nuevo Rol/Departamento"
                        style="flex-grow: 1;">
                    <button class="btn-primary" onclick="openDeptConfigPanel()">+ A√±adir Rol/Departamento</button>
                </div>
            </div>

            <div class="section" id="generation-config-section">
                <h2>üìÖ Configuraci√≥n de Generaci√≥n</h2>
                <div class="main-grid" style="display: grid; grid-template-columns: 1fr; gap: 20px;">
                    <div class="col-left">
                        <div class="flex-row">
                            <label for="semanas">Total de Filas (Turnos):</label>
                            <input type="number" id="semanas" value="12" min="1" style="width: 60px;">
                        </div>

                        <div class="tabs">
                            <button class="tab-button active" onclick="changeRowMode('date', this)">Modo Fecha</button>
                            <button class="tab-button" onclick="changeRowMode('turn', this)">Modo Turnos</button>
                            <button class="tab-button" onclick="changeRowMode('time_slots', this)">Modo Tramos</button>
                        </div>

                        <div id="row-mode-content">
                            <div id="row-mode-date" class="tab-content" style="display: block;">
                                <div style="margin-bottom: 10px;">
                                    <label for="start-date" style="display: block; margin-bottom: 5px;">Fecha de
                                        Inicio:</label>
                                    <input type="date" id="start-date" value="2025-01-01">
                                </div>
                                <div class="flex-row">
                                    <label for="frequency">Frecuencia (Salto Fijo en d√≠as):</label>
                                    <input type="number" id="frequency" value="7" min="1" style="width: 60px;">
                                </div>

                                <div id="date-jump-config">
                                    <p style="font-weight: bold; margin-bottom: 5px;">Saltos Personalizados (Ciclos)</p>
                                    <div class="flex-row" style="margin-bottom: 10px;">
                                        <label for="jump-cycle-freq"
                                            style="font-weight: normal; white-space: nowrap;">Ciclo de Repetici√≥n
                                            (D√≠as):</label>
                                        <input type="number" id="jump-cycle-freq" value="8" min="2"
                                            style="width: 60px;">
                                    </div>
                                    <p
                                        style="font-weight: normal; font-size: 0.9em; margin-bottom: 5px; color: var(--sub-text-color);">
                                        Selecciona los d√≠as que se incluir√°n en la fila dentro del ciclo (1 a **<span
                                            id="cycle-max-day">8</span>**):</p>
                                    <div id="jump-day-selector" class="jump-day-selector">
                                    </div>
                                    <input type="hidden" id="custom-jumps" value="1">
                                </div>

                            </div>
                            <div id="row-mode-turn" class="tab-content" style="display: none;">
                                <div class="flex-row">
                                    <label for="turn-label">Etiqueta Base:</label>
                                    <input type="text" id="turn-label" value="Turno" style="flex-grow: 1;">
                                </div>
                                <div class="flex-row">
                                    <label for="turn-format">Formato:</label>
                                    <select id="turn-format" style="flex-grow: 1;">
                                        <option value="numeric">1, 2, 3...</option>
                                        <option value="alphabetic">A, B, C...</option>
                                    </select>
                                </div>
                            </div>
                            <div id="row-mode-time-slots" class="tab-content" style="display: none;">
                                <div class="flex-row">
                                    <label for="time-slot-days">D√≠as (ej. L, M, X):</label>
                                    <input type="text" id="time-slot-days" value="Lunes, Martes, Mi√©rcoles"
                                        style="flex-grow: 1;">
                                </div>
                                <div class="flex-row">
                                    <label for="time-slot-times">Tramos (ej. 10:00, 17:00):</label>
                                    <input type="text" id="time-slot-times" value="10:00, 17:00" style="flex-grow: 1;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <p id="slots-warning"
                    style="font-size: 0.9em; color: var(--btn-danger-bg); font-weight: bold; margin-top: 15px;">
                    ‚ö†Ô∏è ¬°Debes a√±adir al menos 1 Rol/Departamento en la secci√≥n superior para generar el cuadrante!
                </p>

                <button class="btn-primary" style="width: 100%; font-size: 1.2em; margin-top: 20px;"
                    onclick="generarCuadrante()">üöÄ Generar Cuadrante Final</button>
                <div id="continue-generation-panel"
                    style="display:none; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                    <p style="font-weight: bold; color: var(--text-color);">Cuadrante cargado. ¬øQuieres generar filas
                        adicionales?</p>
                    <button class="btn-primary" style="width: 100%;" onclick="generarCuadrante(true)">‚û°Ô∏è Continuar
                        Generaci√≥n</button>
                </div>
            </div>

            <div id="resultados">
            </div>
        </div>
    </div>

    <div id="config-modal">
        <div id="modal-content-wrapper">
            <button id="modal-close-btn" onclick="closeModal()">√ó</button>
            <div id="modal-content">
            </div>
            <div id="modal-footer"
                style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                <button class="btn-primary" style="width: 100%;" id="modal-save-btn">Guardar Configuraci√≥n</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. ESTRUCTURAS DE DATOS GLOBALES ---
        const QUADRANT_STORAGE_KEY = 'cuadrante_history';
        const CONFIG_STORAGE_KEY = 'cuadrante_last_config';

        let PEOPLE_DATA = [];
        let GROUPS_DATA = [];
        let DEPARTMENTS_DATA = [];
        let SLOT_HEADERS = [];
        let currentRowMode = 'date';
        let isEditingPersonId = null;
        let isEditingDeptId = null;
        let ULTIMO_CUADRANTE_GENERADO = null;
        let ACTIVE_QUADRANT_ID = null;

        // --- SISTEMA DE HISTORIAL (UNDO/REDO) ---
        const HISTORY = [];
        let historyIndex = -1;
        const MAX_HISTORY = 20;

        function saveState() {
            // Limpiar los estados de 'redo'
            if (historyIndex < HISTORY.length - 1) {
                HISTORY.splice(historyIndex + 1);
            }

            const state = {
                people: JSON.parse(JSON.stringify(PEOPLE_DATA)),
                groups: JSON.parse(JSON.stringify(GROUPS_DATA)),
                departments: JSON.parse(JSON.stringify(DEPARTMENTS_DATA)),
            };

            HISTORY.push(state);

            if (HISTORY.length > MAX_HISTORY) {
                HISTORY.shift();
            } else {
                historyIndex++;
            }

            updateHistoryButtons();
            saveLastConfiguration();
        }

        function loadState(state) {
            PEOPLE_DATA = state.people.map(p => ({
                ...p,
                availableSlots: new Set(p.availableSlots || [])
            }));
            GROUPS_DATA = state.groups;
            DEPARTMENTS_DATA = state.departments;
            SLOT_HEADERS = DEPARTMENTS_DATA.map(d => d.name);

            renderPeopleList();
            renderDepartmentList();
            updateHistoryButtons();
        }

        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                loadState(HISTORY[historyIndex]);
                showNotification("‚Ü©Ô∏è Acci√≥n deshecha.", 'info');
            }
        }

        function redo() {
            if (historyIndex < HISTORY.length - 1) {
                historyIndex++;
                loadState(HISTORY[historyIndex]);
                showNotification("‚Ü™Ô∏è Acci√≥n rehecha.", 'info');
            }
        }

        function updateHistoryButtons() {
            document.getElementById('undo-btn').disabled = historyIndex <= 0;
            document.getElementById('redo-btn').disabled = historyIndex >= HISTORY.length - 1;
        }

        const generateId = (prefix) => prefix + Date.now() + Math.floor(Math.random() * 1000);

        // --- 2. GESTI√ìN DE INTERFAZ (DOM) ---

        let notificationTimeout;
        function showNotification(message, type = 'info') {
            const bar = document.getElementById('notification-bar');
            clearTimeout(notificationTimeout);

            bar.textContent = message;
            bar.className = 'error success info'; // Reset classes
            bar.classList.add('show', type);

            notificationTimeout = setTimeout(() => {
                bar.classList.remove('show');
            }, 3000);
        }

        function toggleDarkMode() {
            const isDarkMode = document.getElementById('dark-mode-toggle').checked;
            document.body.classList.toggle('dark-mode', isDarkMode);
            localStorage.setItem('dark-mode', isDarkMode);
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function closeModal() {
            document.getElementById('config-modal').classList.remove('open');
            isEditingPersonId = null;
            isEditingDeptId = null;
            document.getElementById('modal-save-btn').onclick = null;
            document.getElementById('new-person-name').value = '';
            document.getElementById('new-dept-name').value = '';
        }

        // --- TABS DE MODO DE FILA (CORRECCI√ìN TYPEERROR) ---
        function changeRowMode(mode, button) {
            currentRowMode = mode;

            // Usar querySelectorAll en un elemento contenedor si es posible, o asegurarnos de que la selecci√≥n existe.
            const contents = document.querySelectorAll('#generation-config-section .tab-content');
            const buttons = document.querySelectorAll('#generation-config-section .tabs .tab-button');

            if (!button) {
                // Correcci√≥n del TypeError: Si la funci√≥n se llama sin un bot√≥n (ej. al cargar la configuraci√≥n),
                // buscamos el bot√≥n activo basado en el modo cargado.
                button = Array.from(buttons).find(btn => btn.textContent.toLowerCase().includes(mode.replace('_', ' '))) || buttons[0];
            }

            contents.forEach(c => c.style.display = 'none');
            buttons.forEach(b => b.classList.remove('active'));

            if (document.getElementById(`row-mode-${mode}`)) {
                document.getElementById(`row-mode-${mode}`).style.display = 'block';
            }
            if (button) {
                button.classList.add('active');
            }
        }

        // --- L√ìGICA DE SALTO PERSONALIZADO ---
        function updateJumpDaySelector() {
            const cycleFreqInput = document.getElementById('jump-cycle-freq');
            let cycleDays = parseInt(cycleFreqInput.value) || 8;
            cycleDays = Math.max(2, Math.min(31, cycleDays));
            cycleFreqInput.value = cycleDays;

            document.getElementById('cycle-max-day').textContent = cycleDays;
            const selectorDiv = document.getElementById('jump-day-selector');
            const customJumpsInput = document.getElementById('custom-jumps');

            const currentJumps = new Set(
                customJumpsInput.value.split(',')
                    .map(Number)
                    .filter(n => n >= 1 && n <= cycleDays)
            );

            if (currentJumps.size === 0) {
                currentJumps.add(1);
            }

            let newHTML = '';
            for (let i = 1; i <= cycleDays; i++) {
                const isChecked = currentJumps.has(i);
                newHTML += `
                    <label>
                        <input type="checkbox" data-day="${i}" ${isChecked ? 'checked' : ''} onchange="updateCustomJumps()">
                        <span>D√≠a ${i}</span>
                    </label>
                `;
            }
            selectorDiv.innerHTML = newHTML;
            updateCustomJumps();
        }

        function updateCustomJumps() {
            const customJumpsInput = document.getElementById('custom-jumps');
            let checkedDays = Array.from(document.querySelectorAll('#jump-day-selector input:checked'))
                .map(input => parseInt(input.dataset.day))
                .sort((a, b) => a - b);

            if (checkedDays.length === 0) {
                const day1Checkbox = document.querySelector('#jump-day-selector input[data-day="1"]');
                if (day1Checkbox) {
                    day1Checkbox.checked = true;
                    checkedDays = [1];
                }
            }
            customJumpsInput.value = checkedDays.join(',');
        }

        // --- GRUPOS ---
        function addNewGroupFromModal() {
            const newName = document.getElementById('new-group-name').value.trim();
            if (!newName) {
                showNotification("El nombre del grupo no puede estar vac√≠o.", 'warning');
                return;
            }
            if (GROUPS_DATA.some(g => g.name === newName)) {
                showNotification("Ya existe un grupo con ese nombre.", 'warning');
                return;
            }

            saveState(); // Guardar estado antes de la acci√≥n

            const newGroup = { id: generateId('g'), name: newName };
            GROUPS_DATA.push(newGroup);

            // Actualizar selector de grupos en el modal
            const select = document.getElementById('person-config-group');
            const newOption = document.createElement('option');
            newOption.value = newGroup.id;
            newOption.textContent = newGroup.name;
            newOption.selected = true; // Seleccionar el nuevo grupo
            select.appendChild(newOption);

            document.getElementById('new-group-name').value = '';
            showNotification(`Grupo "${newName}" creado.`, 'success');
        }

        // --- REGLAS ---
        function addPersonRule(type) {
            const selectId = type === 'restriction' ? 'res-p2-select' : 'obl-p2-select';
            const listId = type === 'restriction' ? 'person-restrictions-list' : 'person-obligations-list';
            const p2Name = document.getElementById(selectId).value;

            if (!p2Name) {
                showNotification(`Debes seleccionar una persona para a√±adir la regla de ${type}.`, 'error');
                return;
            }

            const currentRules = Array.from(document.querySelectorAll(`#${listId} .rule-badge`)).map(item => item.dataset.person);
            if (currentRules.includes(p2Name)) {
                showNotification(`La regla de ${type} con ${p2Name} ya existe.`, 'warning');
                return;
            }

            const list = document.getElementById(listId);
            const isRestriction = type === 'restriction';
            const icon = isRestriction ? 'üö´' : 'üîó';
            const badgeClass = isRestriction ? 'rule-restriction' : 'rule-obligation';
            const text = p2Name;

            const pNoRules = list.querySelector('p');
            if (pNoRules) pNoRules.remove();

            const ruleElement = document.createElement('div');
            ruleElement.className = `rule-badge ${badgeClass}`;
            ruleElement.dataset.person = p2Name;
            ruleElement.innerHTML = `
                ${icon} ${text} 
                <span class="rule-badge-remove" onclick="removePersonRule(this, '${type}')">√ó</span>
            `;

            list.appendChild(ruleElement);
            document.getElementById(selectId).value = ''; // Limpiar selector
        }

        function removePersonRule(element, type) {
            const item = element.closest('.rule-badge');
            const list = item.parentElement;
            item.remove();

            if (list.children.length === 0) {
                const isRestriction = type === 'restriction';
                list.innerHTML = `<p style="font-size: 0.8em; color: var(--sub-text-color);">No hay reglas de ${isRestriction ? 'exclusi√≥n' : 'inclusi√≥n'} activas.</p>`;
            }
        }

        function renderRulesForPerson(rules, type) {
            const allPeople = PEOPLE_DATA.filter(p => p.id !== isEditingPersonId).map(p => p.name);
            const isRestriction = type === 'restriction';
            const icon = isRestriction ? 'üö´' : 'üîó';
            const badgeClass = isRestriction ? 'rule-restriction' : 'rule-obligation';

            const listHtml = rules.map(r => {
                if (!allPeople.includes(r) && !PEOPLE_DATA.some(p => p.name === r)) return '';
                return `
                    <div class="rule-badge ${badgeClass}" data-person="${r}">
                        ${icon} ${r}
                        <span class="rule-badge-remove" onclick="removePersonRule(this, '${type}')">√ó</span>
                    </div>
                `;
            }).join('');

            return listHtml || `<p style="font-size: 0.8em; color: var(--sub-text-color);">No hay reglas de ${isRestriction ? 'exclusi√≥n' : 'inclusi√≥n'} activas.</p>`;
        }

        // --- PERSONAS ---
        function getPersonBadges(personName) {
            const person = PEOPLE_DATA.find(p => p.name === personName);
            if (!person) return '';

            let badges = getDepartmentBadges(personName);

            // Miniaturas de Reglas (Nueva Inclusi√≥n)
            if (person.restrictions.length > 0) {
                badges += `<span class="rule-badge rule-restriction" title="Restricci√≥n con: ${person.restrictions.join(', ')}">üö´ ${person.restrictions.length}</span>`;
            }
            if (person.obligations.length > 0) {
                badges += `<span class="rule-badge rule-obligation" title="Obligaci√≥n con: ${person.obligations.join(', ')}">üîó ${person.obligations.length}</span>`;
            }

            return badges.length > 0 ? `<div class="rule-badge-list">${badges}</div>` : '';
        }

        function getDepartmentBadges(personName) {
            const deptInfo = DEPARTMENTS_DATA.filter(d => {
                const person = PEOPLE_DATA.find(p => p.name === personName);
                if (d.members.includes(personName)) return true;
                if (person && person.groupId && d.members.includes(person.groupId)) return true;
                return false;
            }).map(d => d.name);

            return deptInfo.length > 0 ? `<span class="member-badge">${deptInfo.join(', ')}</span>` : '';
        }

        function renderPeopleList() {
            const listDiv = document.getElementById('person-list');
            listDiv.innerHTML = '';

            if (PEOPLE_DATA.length === 0) {
                listDiv.innerHTML = '<p style="font-size: 0.9em; color: var(--sub-text-color);">No hay personas a√±adidas.</p>';
                updateGroupDependentOptions();
                return;
            }

            const peopleByGroup = PEOPLE_DATA.reduce((acc, person) => {
                const groupName = GROUPS_DATA.find(g => g.id === person.groupId)?.name || 'Sin Grupo';
                if (!acc[groupName]) acc[groupName] = [];
                acc[groupName].push(person);
                return acc;
            }, {});

            Object.keys(peopleByGroup).sort((a, b) => {
                if (a === 'Sin Grupo') return 1;
                if (b === 'Sin Grupo') return -1;
                return a.localeCompare(b);
            }).forEach(groupName => {
                const showHeader = GROUPS_DATA.length > 0 || (groupName === 'Sin Grupo' && PEOPLE_DATA.length > 0);

                if (showHeader) {
                    listDiv.innerHTML += `<div class="group-header" data-group-id="${PEOPLE_DATA.find(p => (GROUPS_DATA.find(g => g.id === p.groupId)?.name || 'Sin Grupo') === groupName)?.groupId || 'none'}">üë• ${groupName}</div>`;
                }

                peopleByGroup[groupName].forEach(person => {
                    const badges = getPersonBadges(person.name);

                    const card = document.createElement('div');
                    card.className = `person-card`;
                    card.innerHTML = `
                        <div class="person-info">${person.name} ${badges}</div>
                        <div>
                            <button class="icon-btn" onclick="openPersonConfigPanel('${person.id}')" title="Editar"><span role="img" aria-label="Editar">‚úèÔ∏è</span></button>
                            <button class="icon-btn icon-btn-danger" onclick="confirmRemovePerson('${person.id}')" title="Eliminar"><span role="img" aria-label="Eliminar">üóëÔ∏è</span></button>
                        </div>
                    `;
                    listDiv.appendChild(card);
                });
            });

            updateGroupDependentOptions();
            saveLastConfiguration();
        }

        function openPersonConfigPanel(personId = null) {
            const modal = document.getElementById('config-modal');
            const content = document.getElementById('modal-content');
            const personNameInput = document.getElementById('new-person-name');
            const modalSaveBtn = document.getElementById('modal-save-btn');

            isEditingPersonId = personId;
            isEditingDeptId = null;
            modalSaveBtn.onclick = savePersonConfig;

            let person = null;
            let title = 'A√±adir Nueva Persona';
            let initialName = personNameInput.value.trim();

            if (personId) {
                person = PEOPLE_DATA.find(p => p.id === personId);
                if (!person) { closeModal(); return; }
                title = `Editar: ${person.name}`;
                initialName = person.name;
            } else {
                person = {
                    name: initialName,
                    groupId: GROUPS_DATA[0]?.id || '',
                    restrictions: [],
                    obligations: [],
                    availableSlots: new Set()
                };
            }

            const allPeople = PEOPLE_DATA.filter(p => p.id !== personId).map(p => p.name);

            // Contenido del Modal
            content.innerHTML = `
                <h3>${title}</h3>
                <input type="text" id="person-config-name" value="${initialName}" placeholder="Nombre de la persona" style="width: 100%; margin-bottom: 15px; font-size: 1.1em;">
                
                <div class="modal-section">
                    <h4>Asignaci√≥n de Grupo</h4>
                    <select id="person-config-group" style="width: 100%;">
                        <option value="">(Sin Grupo)</option>
                        ${GROUPS_DATA.map(g =>
                `<option value="${g.id}" ${person.groupId === g.id ? 'selected' : ''}>${g.name}</option>`
            ).join('')}
                    </select>
                    <div class="flex-row" style="margin-top: 10px;">
                        <input type="text" id="new-group-name" placeholder="Crear nuevo grupo" style="flex-grow: 1;">
                        <button class="btn-small btn-secondary" onclick="addNewGroupFromModal()">+ Crear</button>
                    </div>
                </div>
                
                <div class="modal-section">
                    <h4>Reglas de Obligaci√≥n (Inclusi√≥n)</h4>
                    <p style="font-size:0.8em; color:var(--sub-text-color);">Esta persona solo puede estar si otra/s est√°/n.</p>
                    <div id="person-obligations-list" style="display: flex; flex-wrap: wrap; gap: 5px; min-height: 40px;">
                        ${renderRulesForPerson(person.obligations, 'obligation')}
                    </div>
                    <div class="flex-row" style="margin-top: 10px;">
                        <select id="obl-p2-select" style="flex-grow: 1;">
                            <option value="">(Requerido)</option>
                            ${allPeople.map(p => `<option value="${p}">${p}</option>`).join('')}
                        </select>
                        <button class="btn-small btn-secondary" onclick="addPersonRule('obligation')">A√±adir</button>
                    </div>
                </div>

                <div class="modal-section">
                    <h4>Reglas de Restricci√≥n (Exclusi√≥n)</h4>
                    <p style="font-size:0.8em; color:var(--sub-text-color);">Esta persona no puede estar con otra.</p>
                    <div id="person-restrictions-list" style="display: flex; flex-wrap: wrap; gap: 5px; min-height: 40px;">
                        ${renderRulesForPerson(person.restrictions, 'restriction')}
                    </div>
                    <div class="flex-row" style="margin-top: 10px;">
                        <select id="res-p2-select" style="flex-grow: 1;">
                            <option value="">(Prohibido con)</option>
                            ${allPeople.map(p => `<option value="${p}">${p}</option>`).join('')}
                        </select>
                        <button class="btn-small btn-secondary" onclick="addPersonRule('restriction')">A√±adir</button>
                    </div>
                </div>
            `;

            modal.classList.add('open');
        }

        function savePersonConfig() {
            const name = document.getElementById('person-config-name').value.trim();
            const groupId = document.getElementById('person-config-group').value;

            if (!name) {
                showNotification("El nombre de la persona es obligatorio.", 'error');
                return;
            }

            let restrictions = [];
            document.querySelectorAll('#person-restrictions-list .rule-badge').forEach(item => {
                restrictions.push(item.dataset.person);
            });

            let obligations = [];
            document.querySelectorAll('#person-obligations-list .rule-badge').forEach(item => {
                obligations.push(item.dataset.person);
            });

            const newPersonData = {
                name: name,
                groupId: groupId,
                restrictions: restrictions,
                obligations: obligations,
            };

            const existingPerson = PEOPLE_DATA.find(p => p.name === name);

            saveState(); // Guardar estado antes de la acci√≥n

            if (isEditingPersonId) {
                const index = PEOPLE_DATA.findIndex(p => p.id === isEditingPersonId);
                if (index !== -1) {
                    // Si cambia el nombre, actualizar referencias en departamentos
                    if (PEOPLE_DATA[index].name !== name) {
                        DEPARTMENTS_DATA.forEach(d => {
                            const memberIndex = d.members.indexOf(PEOPLE_DATA[index].name);
                            if (memberIndex !== -1) d.members[memberIndex] = name;
                        });
                        // Actualizar referencias en otras personas (reglas)
                        PEOPLE_DATA.forEach(p => {
                            p.restrictions = p.restrictions.map(r => r === PEOPLE_DATA[index].name ? name : r);
                            p.obligations = p.obligations.map(o => o === PEOPLE_DATA[index].name ? name : o);
                        });
                    }
                    PEOPLE_DATA[index] = { ...PEOPLE_DATA[index], ...newPersonData };
                }
                showNotification(`Persona "${name}" actualizada.`, 'success');
            } else {
                if (existingPerson) {
                    showNotification(`Ya existe una persona con el nombre "${name}".`, 'error');
                    return;
                }
                newPersonData.id = generateId('p');
                newPersonData.availableSlots = new Set();
                PEOPLE_DATA.push(newPersonData);
                showNotification(`Persona "${name}" a√±adida.`, 'success');
            }

            closeModal();
            renderPeopleList();
            renderDepartmentList();
        }

        function confirmRemovePerson(personId) {
            const personName = PEOPLE_DATA.find(p => p.id === personId)?.name;
            if (confirm(`¬øEst√°s seguro de que quieres eliminar a ${personName}? Esta acci√≥n no se puede deshacer de forma f√°cil.`)) {
                removePerson(personId, personName);
            }
        }

        function removePerson(personId, personName) {
            saveState(); // Guardar estado antes de la acci√≥n

            PEOPLE_DATA = PEOPLE_DATA.filter(p => p.id !== personId);

            // Limpiar referencias en otras personas y departamentos
            PEOPLE_DATA.forEach(p => {
                p.restrictions = p.restrictions.filter(r => r !== personName);
                p.obligations = p.obligations.filter(o => o !== personName);
            });
            DEPARTMENTS_DATA.forEach(d => {
                d.members = d.members.filter(m => m !== personName);
            });

            renderPeopleList();
            renderDepartmentList();
            showNotification(`Persona "${personName}" eliminada.`, 'info');
        }

        function updateGroupDependentOptions() {
            const groupOptionsDiv = document.getElementById('same-group-option');
            const hasGroups = GROUPS_DATA.length > 0;
            groupOptionsDiv.style.display = hasGroups ? 'flex' : 'none';
        }

        // --- DEPARTAMENTOS (SLOTS/ROLES) ---
        function renderDepartmentList() {
            const listDiv = document.getElementById('department-list');
            listDiv.innerHTML = '';

            SLOT_HEADERS = DEPARTMENTS_DATA.map(d => d.name);
            updateSlotsWarning();

            if (DEPARTMENTS_DATA.length === 0) {
                listDiv.innerHTML = '<p style="font-size: 0.9em; color: var(--sub-text-color);">No hay Roles/Departamentos definidos. Cada uno es una columna del cuadrante.</p>';
                return;
            }

            DEPARTMENTS_DATA.forEach(dept => {
                const peopleMembers = dept.members.filter(m => !m.startsWith('g')).length;
                const groupMembers = dept.members.filter(m => m.startsWith('g')).length;

                const groupNames = dept.members.filter(m => m.startsWith('g')).map(groupId => GROUPS_DATA.find(g => g.id === groupId)?.name || 'Grupo Desconocido');
                const membersSample = dept.members.filter(m => !m.startsWith('g')).slice(0, 3).join(', ');
                const memberCountText = `${peopleMembers} ${peopleMembers === 1 ? 'Persona' : 'Personas'}${groupMembers > 0 ? ` + ${groupMembers} ${groupMembers === 1 ? 'Grupo' : 'Grupos'}` : ''}`;

                const card = document.createElement('div');
                card.className = `dept-card`;

                card.innerHTML = `
                    <div style="font-weight: bold;">
                        ${dept.name} 
                        <span style="font-weight: normal; font-size: 0.9em; color: var(--sub-text-color);">
                            (${memberCountText})
                        </span>
                        <div style="font-weight: normal; font-size: 0.8em; margin-top: 3px;">
                            ${membersSample}${peopleMembers > 3 ? ` y ${peopleMembers - 3} m√°s` : ''}
                            ${groupNames.length > 0 ? ` | Grupos: ${groupNames.join(', ')}` : ''}
                        </div>
                    </div>
                    <div>
                        <button class="icon-btn" onclick="openDeptConfigPanel('${dept.id}')" title="Editar"><span role="img" aria-label="Editar">‚úèÔ∏è</span></button>
                        <button class="icon-btn icon-btn-danger" onclick="confirmRemoveDept('${dept.id}')" title="Eliminar"><span role="img" aria-label="Eliminar">üóëÔ∏è</span></button>
                    </div>
                `;
                listDiv.appendChild(card);
            });
            renderPeopleList();
            saveLastConfiguration();
        }

        function updateSlotsWarning() {
            const warning = document.getElementById('slots-warning');
            warning.style.display = DEPARTMENTS_DATA.length === 0 ? 'block' : 'none';
        }

        function openDeptConfigPanel(deptId = null) {
            const modal = document.getElementById('config-modal');
            const content = document.getElementById('modal-content');
            const deptNameInput = document.getElementById('new-dept-name');
            const modalSaveBtn = document.getElementById('modal-save-btn');

            isEditingDeptId = deptId;
            isEditingPersonId = null;
            modalSaveBtn.onclick = saveDeptConfig;

            let dept = null;
            let title = 'A√±adir Nuevo Rol/Departamento';
            let initialName = deptNameInput.value.trim();

            if (deptId) {
                dept = DEPARTMENTS_DATA.find(d => d.id === deptId);
                if (!dept) { closeModal(); return; }
                title = `Editar: ${dept.name}`;
                initialName = dept.name;
            } else {
                dept = { name: initialName, id: null, members: [] };
            }

            const currentMembers = new Set(dept.members);

            const groupOptions = GROUPS_DATA.map(g => {
                const checked = currentMembers.has(g.id) ? 'checked' : '';
                return `
                    <label style="display: block; margin-bottom: 5px;">
                        <input type="checkbox" value="${g.id}" class="dept-member-group" ${checked}> 
                        ${g.name} (Grupo)
                    </label>
                `;
            }).join('');

            const personOptions = PEOPLE_DATA.map(p => {
                const checked = currentMembers.has(p.name) ? 'checked' : '';
                return `
                    <label style="display: block; margin-bottom: 5px;">
                        <input type="checkbox" value="${p.name}" class="dept-member-person" ${checked}> 
                        ${p.name}
                    </label>
                `;
            }).join('');

            content.innerHTML = `
                <h3>${title}</h3>
                <input type="text" id="dept-config-name" value="${initialName}" placeholder="Nombre del Rol/Departamento" style="width: 100%; margin-bottom: 15px; font-size: 1.1em;">
                
                <div class="modal-section">
                    <h4>Asignar Personas/Grupos al Rol:</h4>
                    <p style="font-size: 0.8em; color: var(--sub-text-color); margin-bottom: 10px;">Selecciona qui√©n puede ser asignado a esta columna.</p>
                    
                    <div style="max-height: 250px; overflow-y: auto; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--sub-panel-bg);">
                        <label style="display: block; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid var(--panel-border);">
                            <input type="checkbox" onchange="toggleSelectAll('dept-member-person', this)"> 
                            Seleccionar/Deseleccionar Todas las Personas
                        </label>
                        ${groupOptions}
                        ${personOptions}
                        ${PEOPLE_DATA.length === 0 ? '<p style="text-align: center; color: var(--sub-text-color);">No hay personas a√±adidas.</p>' : ''}
                    </div>
                </div>
            `;

            deptNameInput.value = '';
            modal.classList.add('open');
        }

        function toggleSelectAll(className, button) {
            const checkboxes = document.querySelectorAll(`.${className}`);
            const isChecked = button.checked;
            checkboxes.forEach(cb => {
                cb.checked = isChecked;
            });
        }

        function saveDeptConfig() {
            const name = document.getElementById('dept-config-name').value.trim();
            if (!name) {
                showNotification("El nombre del Rol/Departamento es obligatorio.", 'error');
                return;
            }

            const selectedMembers = [];
            document.querySelectorAll('.dept-member-person:checked, .dept-member-group:checked').forEach(cb => {
                selectedMembers.push(cb.value);
            });

            const newDeptData = {
                name: name,
                members: selectedMembers,
            };

            saveState(); // Guardar estado antes de la acci√≥n

            if (isEditingDeptId) {
                const index = DEPARTMENTS_DATA.findIndex(d => d.id === isEditingDeptId);
                if (index !== -1) {
                    // Si cambia el nombre, actualizar referencias en el header
                    if (DEPARTMENTS_DATA[index].name !== name) {
                        SLOT_HEADERS = SLOT_HEADERS.map(h => h === DEPARTMENTS_DATA[index].name ? name : h);
                    }
                    DEPARTMENTS_DATA[index] = { ...DEPARTMENTS_DATA[index], ...newDeptData };
                }
                showNotification(`Rol/Departamento "${name}" actualizado.`, 'success');
            } else {
                if (DEPARTMENTS_DATA.some(d => d.name === name)) {
                    showNotification(`Ya existe un Rol/Departamento con el nombre "${name}".`, 'error');
                    return;
                }
                newDeptData.id = generateId('d');
                DEPARTMENTS_DATA.push(newDeptData);
                SLOT_HEADERS.push(name);
                showNotification(`Rol/Departamento "${name}" a√±adido.`, 'success');
            }

            closeModal();
            renderDepartmentList();
            renderPeopleList();
        }

        function confirmRemoveDept(deptId) {
            const deptName = DEPARTMENTS_DATA.find(d => d.id === deptId)?.name;
            if (confirm(`¬øEst√°s seguro de que quieres eliminar el Rol/Departamento "${deptName}"? Esta acci√≥n no se puede deshacer de forma f√°cil.`)) {
                removeDept(deptId, deptName);
            }
        }

        function removeDept(deptId, deptName) {
            saveState(); // Guardar estado antes de la acci√≥n

            DEPARTMENTS_DATA = DEPARTMENTS_DATA.filter(d => d.id !== deptId);
            SLOT_HEADERS = SLOT_HEADERS.filter(h => h !== deptName);

            renderDepartmentList();
            renderPeopleList();
            showNotification(`Rol/Departamento "${deptName}" eliminado.`, 'info');
        }

        // --- 3. L√ìGICA DE GENERACI√ìN ---
        function getConfigurationForGeneration() {
            return {
                semanas: parseInt(document.getElementById('semanas').value) || 12,
                slots: DEPARTMENTS_DATA.length,
                rowMode: currentRowMode,
                startDate: document.getElementById('start-date').value,
                frequency: parseInt(document.getElementById('frequency').value) || 7,
                jumpCycleFreq: document.getElementById('jump-cycle-freq').value,
                customJumps: document.getElementById('custom-jumps').value,
                turnLabel: document.getElementById('turn-label').value,
                turnFormat: document.getElementById('turn-format').value,
                timeSlotDays: document.getElementById('time-slot-days').value,
                timeSlotTimes: document.getElementById('time-slot-times').value,
                priorityMode: document.getElementById('priority-mode').value,
                sameGroupOnly: document.getElementById('same-group-only').checked,

                people: PEOPLE_DATA.map(p => ({
                    ...p,
                    availableSlots: Array.from(p.availableSlots)
                })),
                groups: GROUPS_DATA,
                departments: DEPARTMENTS_DATA,
                headers: SLOT_HEADERS,
            };
        }

        function generateRowLabels(semanas, config) {
            const labels = [];

            if (config.rowMode === 'date') {
                const startDate = new Date(config.startDate);
                const jumpCycleFreq = parseInt(config.jumpCycleFreq) || 7;
                const customJumps = config.customJumps.split(',').map(Number).filter(n => n >= 1 && n <= jumpCycleFreq);
                const fixedFrequency = parseInt(config.frequency) || 7;

                let rows = 0;
                let dayOffset = 0;

                const useFixedJump = customJumps.length === 0 || fixedFrequency > 0;

                while (rows < semanas) {
                    if (useFixedJump && fixedFrequency > 0) {
                        const currentDate = new Date(startDate);
                        currentDate.setDate(startDate.getDate() + (rows * fixedFrequency));
                        labels.push({
                            label: currentDate.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                            isDayBreak: false
                        });
                        rows++;

                    } else if (customJumps.length > 0) {
                        const cycleIndex = (dayOffset % jumpCycleFreq) + 1;

                        if (customJumps.includes(cycleIndex)) {
                            const currentDate = new Date(startDate);
                            currentDate.setDate(startDate.getDate() + dayOffset);
                            labels.push({
                                label: currentDate.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                                isDayBreak: cycleIndex === customJumps[0] && rows > 0
                            });
                            rows++;
                        }
                        dayOffset++;

                    } else {
                        // Fallback: Salto de 1 d√≠a
                        const currentDate = new Date(startDate);
                        currentDate.setDate(startDate.getDate() + rows);
                        labels.push({
                            label: currentDate.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                            isDayBreak: rows % 7 === 0 && rows > 0
                        });
                        rows++;
                    }
                }
            } else if (config.rowMode === 'turn') {
                for (let i = 0; i < semanas; i++) {
                    let suffix = config.turnFormat === 'numeric' ? i + 1 : String.fromCharCode(65 + i % 26);
                    labels.push({ label: `${config.turnLabel} ${suffix}`, isDayBreak: false });
                }
            } else if (config.rowMode === 'time_slots') {
                const days = config.timeSlotDays.split(',').map(d => d.trim()).filter(d => d.length > 0);
                const times = config.timeSlotTimes.split(',').map(t => t.trim()).filter(t => t.length > 0);

                let actualRows = 0;
                let dayIndex = 0;

                while (actualRows < semanas) {
                    const dayLabel = days[dayIndex % days.length];
                    for (const timeLabel of times) {
                        if (actualRows < semanas) {
                            labels.push({
                                label: `${dayLabel} - ${timeLabel}`,
                                isDayBreak: actualRows > 0 && (times.indexOf(timeLabel) === 0)
                            });
                            actualRows++;
                        }
                    }
                    dayIndex++;
                }
            }
            return labels.slice(0, semanas);
        }

        function checkPersonAvailabilityForDept(personName, deptId, config) {
            const person = config.people.find(p => p.name === personName);
            const department = config.departments.find(d => d.id === deptId);

            if (!person || !department) return false;

            if (department.members.includes(personName)) {
                return true;
            }

            if (person.groupId && department.members.includes(person.groupId)) {
                return true;
            }

            return false;
        }

        function generarCuadrante(isContinuing = false) {
            const config = getConfigurationForGeneration();
            const slotsToGenerate = config.slots;

            if (slotsToGenerate === 0) {
                showNotification("Debes a√±adir al menos un Rol/Departamento para generar el cuadrante.", 'error');
                return;
            }

            const allPeopleNames = config.people.map(p => p.name);
            if (allPeopleNames.length === 0) {
                showNotification("Debes a√±adir personas para generar el cuadrante.", 'error');
                return;
            }

            let initialCuadrante = [];
            let totalWeeks = config.semanas;

            if (isContinuing && ULTIMO_CUADRANTE_GENERADO) {
                initialCuadrante = ULTIMO_CUADRANTE_GENERADO.cuadrante;
                totalWeeks += initialCuadrante.length;
            }

            const cuadranteGenerado = [];
            const rowLabels = generateRowLabels(totalWeeks, config).slice(initialCuadrante.length);

            // Simulaci√≥n de Asignaci√≥n Round Robin (mejorada para mayor complejidad)
            let personIndex = 0;

            for (let w = 0; w < rowLabels.length; w++) {
                const weekSlots = [];
                const assignedInRow = new Set();

                for (let s = 0; s < slotsToGenerate; s++) {
                    const dept = config.departments[s];
                    const deptId = dept.id;
                    let assignedPerson = 'VAC√çO';
                    let found = false;

                    // L√≥gica para cumplir Obligaciones (simplificada: si una obligaci√≥n puede cumplirse, debe ir primero)
                    const requiredPeople = allPeopleNames.filter(name => {
                        const personData = config.people.find(p => p.name === name);
                        return personData.obligations.some(oblName => assignedInRow.has(oblName));
                    });

                    // Priorizar la lista de personas para rotaci√≥n
                    const rotationList = [...requiredPeople, ...allPeopleNames].filter((v, i, a) => a.indexOf(v) === i);

                    for (let i = 0; i < rotationList.length; i++) {
                        const person = rotationList[(personIndex + i) % rotationList.length];
                        const personData = config.people.find(p => p.name === person);

                        const isAvailableForDept = checkPersonAvailabilityForDept(person, deptId, config);
                        const notAlreadyAssigned = !assignedInRow.has(person);

                        if (isAvailableForDept && notAlreadyAssigned) {

                            let isConflict = false;
                            for (const otherPerson of assignedInRow) {
                                // Restricci√≥n: No puede estar con esta otra persona (Exclusi√≥n)
                                if (personData.restrictions.includes(otherPerson) || config.people.find(p => p.name === otherPerson)?.restrictions.includes(person)) {
                                    isConflict = true;
                                    break;
                                }
                            }

                            // Regla de grupo (solo si est√° activa)
                            if (!isConflict && config.sameGroupOnly && assignedInRow.size > 0) {
                                const currentGroup = personData.groupId;
                                const assignedGroups = Array.from(assignedInRow).map(pName => config.people.find(p => p.name === pName).groupId);

                                if (currentGroup && assignedGroups.some(gId => gId !== currentGroup && gId !== '')) {
                                    // Conflicto de grupo: persona con grupo A se asigna con persona de grupo B
                                    isConflict = true;
                                }
                            }

                            if (!isConflict) {
                                assignedPerson = person;
                                assignedInRow.add(person);
                                personIndex = (personIndex + i + 1) % rotationList.length;
                                found = true;
                                break;
                            }
                        }
                    }

                    weekSlots.push({
                        person: assignedPerson,
                        groupId: assignedPerson !== 'VAC√çO' ? config.people.find(p => p.name === assignedPerson).groupId : '',
                        slot: s + 1
                    });

                    if (!found) {
                        personIndex = (personIndex + 1) % rotationList.length;
                    }
                }

                cuadranteGenerado.push({ etiquetaTiempo: rowLabels[w].label, slots: weekSlots, conflictos: [], isDayBreak: rowLabels[w].isDayBreak });
            }

            let finalCuadrante = initialCuadrante.concat(cuadranteGenerado);

            ULTIMO_CUADRANTE_GENERADO = {
                id: generateId('q'),
                label: `Cuadrante Generado - ${new Date().toLocaleString('es-ES')}`,
                config: config,
                cuadrante: finalCuadrante,
            };

            mostrarResultados(ULTIMO_CUADRANTE_GENERADO);
            saveLastConfiguration();
            showNotification("‚úÖ Cuadrante generado con √©xito.", 'success');
        }

        function mostrarResultados(quadrantObject) {
            const resultadosDiv = document.getElementById('resultados');
            if (!quadrantObject || !quadrantObject.cuadrante || quadrantObject.cuadrante.length === 0) {
                resultadosDiv.innerHTML = '<p style="margin-top: 20px; color: var(--sub-text-color);">No hay resultados para mostrar.</p>';
                document.getElementById('continue-generation-panel').style.display = 'none';
                return;
            }

            const config = quadrantObject.config;
            const headers = config.headers;
            const cuadrante = quadrantObject.cuadrante;

            // Renderizar tabla
            let tableHTML = `
                <div class="quadrant-table-container">
                    <table id="quadrant-table">
                        <thead>
                            <tr>
                                <th class="row-label" style="width: 150px;">${config.rowMode === 'date' ? 'Fecha' : 'Turno/Tramo'}</th>
                                ${headers.map(h => `<th>${h}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${cuadrante.map(row => `
                                <tr class="${row.isDayBreak ? 'day-break' : ''}">
                                    <td class="row-label">${row.etiquetaTiempo}</td>
                                    ${row.slots.map(slot => `
                                        <td class="${slot.person === 'VAC√çO' ? 'vacio' : ''} ${row.conflictos.length > 0 ? 'conflict' : ''}">
                                            ${slot.person}
                                        </td>
                                    `).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            // Renderizar resumen (simple)
            const personCounts = {};
            config.people.forEach(p => personCounts[p.name] = 0);
            cuadrante.forEach(row => {
                row.slots.forEach(slot => {
                    if (slot.person !== 'VAC√çO' && personCounts.hasOwnProperty(slot.person)) {
                        personCounts[slot.person]++;
                    }
                });
            });

            let summaryHTML = '<h3>üìä Resumen de Asignaciones</h3>';
            summaryHTML += '<div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px;">';

            Object.keys(personCounts).sort().forEach(person => {
                summaryHTML += `
                    <div style="background: var(--panel-bg); padding: 8px 12px; border-radius: 6px; box-shadow: var(--card-shadow); font-size: 0.9em;">
                        <strong>${person}</strong>: ${personCounts[person]} asignaciones
                    </div>
                `;
            });
            summaryHTML += '</div>';

            resultadosDiv.innerHTML = `
                <h2>Resultados del Cuadrante (${cuadrante.length} Filas)</h2>
                ${tableHTML}
                ${summaryHTML}
            `;

            document.getElementById('continue-generation-panel').style.display = 'block';
            updateTableWidth();
        }

        function updateTableWidth() {
            const tableContainer = document.querySelector('.quadrant-table-container');
            if (tableContainer) {
                tableContainer.scrollLeft = 0;
            }
        }

        // --- 4. PERSISTENCIA Y CARGA/GUARDA ---

        function saveLastConfiguration() {
            const config = getConfigurationForGeneration();
            localStorage.setItem(CONFIG_STORAGE_KEY, JSON.stringify(config));
        }

        function loadConfigurationFromObject(config) {
            // 1. Cargar datos base
            PEOPLE_DATA = config.people.map(p => ({
                ...p,
                availableSlots: new Set(p.availableSlots || [])
            })) || [];
            GROUPS_DATA = config.groups || [];
            DEPARTMENTS_DATA = config.departments || [];
            SLOT_HEADERS = config.headers || [];

            // 2. Cargar opciones de interfaz
            const opts = config;
            document.getElementById('semanas').value = opts.semanas || 12;
            document.getElementById('priority-mode').value = opts.priorityMode || 'frecuencia';
            document.getElementById('same-group-only').checked = opts.sameGroupOnly || false;

            currentRowMode = opts.rowMode || 'date';
            document.getElementById('start-date').value = opts.startDate || new Date().toISOString().substring(0, 10);
            document.getElementById('frequency').value = opts.frequency || 7;
            document.getElementById('jump-cycle-freq').value = opts.jumpCycleFreq || 8;
            document.getElementById('custom-jumps').value = opts.customJumps || '1';

            document.getElementById('turn-label').value = opts.turnLabel || 'Turno';
            document.getElementById('turn-format').value = opts.turnFormat || 'numeric';
            document.getElementById('time-slot-days').value = opts.timeSlotDays || 'Lunes, Martes, Mi√©rcoles';
            document.getElementById('time-slot-times').value = opts.timeSlotTimes || '10:00, 17:00';

            // 3. Renderizar y actualizar
            const rowButtons = document.querySelectorAll('.tab-button');
            const activeBtn = Array.from(rowButtons).find(btn => btn.textContent.toLowerCase().includes(currentRowMode.replace('_', ' '))) || rowButtons[0];
            if (activeBtn) changeRowMode(currentRowMode, activeBtn); // Llama a la versi√≥n corregida

            updateJumpDaySelector();
            renderDepartmentList();
            renderPeopleList();

            // 4. Resetear resultados
            ULTIMO_CUADRANTE_GENERADO = null;
            document.getElementById('resultados').innerHTML = '';
            document.getElementById('continue-generation-panel').style.display = 'none';

            // 5. Reiniciar historial al cargar una configuraci√≥n
            HISTORY.length = 0;
            historyIndex = -1;
            saveState(); // Guardar el estado inicial cargado
        }

        function loadLastConfiguration() {
            const configStr = localStorage.getItem(CONFIG_STORAGE_KEY);
            if (configStr) {
                try {
                    const config = JSON.parse(configStr);
                    loadConfigurationFromObject(config);
                    return true;
                } catch (e) {
                    console.error("Error loading last config:", e);
                }
            }
            return false;
        }

        function saveQuadrant() {
            if (!ULTIMO_CUADRANTE_GENERADO) {
                showNotification("No hay cuadrante generado para guardar.", 'warning');
                return;
            }

            const historyStr = localStorage.getItem(QUADRANT_STORAGE_KEY);
            let history = historyStr ? JSON.parse(historyStr) : [];

            const existingIndex = history.findIndex(q => q.id === ULTIMO_CUADRANTE_GENERADO.id);
            if (existingIndex !== -1) {
                history[existingIndex] = ULTIMO_CUADRANTE_GENERADO;
                showNotification(`Cuadrante "${ULTIMO_CUADRANTE_GENERADO.label}" actualizado.`, 'success');
            } else {
                history.unshift(ULTIMO_CUADRANTE_GENERADO);
                showNotification(`Cuadrante "${ULTIMO_CUADRANTE_GENERADO.label}" guardado.`, 'success');
            }

            localStorage.setItem(QUADRANT_STORAGE_KEY, JSON.stringify(history));
            renderSavedQuadrants();
        }

        function renderSavedQuadrants() {
            const list = document.getElementById('saved-quadrants-list');
            list.innerHTML = '';
            const historyStr = localStorage.getItem(QUADRANT_STORAGE_KEY);
            const history = historyStr ? JSON.parse(historyStr) : [];

            if (history.length === 0) {
                list.innerHTML = '<li style="color: var(--sub-text-color); font-size: 0.9em;">No hay cuadrantes guardados.</li>';
                return;
            }

            history.forEach(q => {
                const li = document.createElement('li');
                li.className = 'sidebar-item';
                li.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--menu-border);">
                        <span style="cursor: pointer; font-weight: 500;" onclick="loadQuadrant('${q.id}')">${q.label}</span>
                        <div class="item-actions">
                            <button class="icon-btn btn-small" onclick="downloadQuadrant('${q.id}')" title="Descargar">‚¨áÔ∏è</button>
                            <button class="icon-btn icon-btn-danger btn-small" onclick="deleteQuadrant('${q.id}')" title="Eliminar">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
                list.appendChild(li);
            });
        }

        function loadQuadrant(id) {
            const historyStr = localStorage.getItem(QUADRANT_STORAGE_KEY);
            const history = historyStr ? JSON.parse(historyStr) : [];
            const q = history.find(item => item.id === id);

            if (q) {
                loadQuadrantObject(q);
                showNotification(`Cuadrante "${q.label}" cargado.`, 'info');
                toggleSidebar();
            } else {
                showNotification("Cuadrante no encontrado.", 'error');
            }
        }

        function loadQuadrantObject(q) {
            loadConfigurationFromObject(q.config);
            ULTIMO_CUADRANTE_GENERADO = q;
            mostrarResultados(q);
            ACTIVE_QUADRANT_ID = q.id;
        }

        function deleteQuadrant(id) {
            if (!confirm("¬øEst√°s seguro de que quieres eliminar este cuadrante guardado?")) return;

            let history = JSON.parse(localStorage.getItem(QUADRANT_STORAGE_KEY) || '[]');
            history = history.filter(q => q.id !== id);
            localStorage.setItem(QUADRANT_STORAGE_KEY, JSON.stringify(history));

            if (ULTIMO_CUADRANTE_GENERADO && ULTIMO_CUADRANTE_GENERADO.id === id) {
                ULTIMO_CUADRANTE_GENERADO = null;
                document.getElementById('resultados').innerHTML = '<p style="margin-top: 20px; color: var(--sub-text-color);">El cuadrante activo ha sido eliminado.</p>';
                document.getElementById('continue-generation-panel').style.display = 'none';
            }

            showNotification("Cuadrante eliminado.", 'info');
            renderSavedQuadrants();
        }

        function downloadQuadrant(id) {
            const history = JSON.parse(localStorage.getItem(QUADRANT_STORAGE_KEY) || '[]');
            const q = history.find(item => item.id === id);

            if (q) {
                const json = JSON.stringify(q, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${q.label.replace(/[^a-z0-9]/gi, '_')}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification(`Descargando "${q.label}".`, 'info');
            } else {
                showNotification("Cuadrante no encontrado para descargar.", 'error');
            }
        }

        function uploadConfiguration(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);

                    if (data.config && data.cuadrante) {
                        loadQuadrantObject(data);
                        showNotification(`Cuadrante "${data.label}" cargado desde archivo.`, 'success');
                    } else if (data.people && data.departments) {
                        loadConfigurationFromObject(data);
                        showNotification("Configuraci√≥n cargada desde archivo.", 'success');
                    } else {
                        throw new Error("Formato de archivo JSON no reconocido.");
                    }
                } catch (error) {
                    showNotification(`Error al cargar el archivo: ${error.message}`, 'error');
                    console.error(error);
                }
            };
            reader.readAsText(file);
        }

        // --- INICIALIZACI√ìN ---
        window.onload = () => {
            const savedMode = localStorage.getItem('dark-mode') === 'true';
            document.getElementById('dark-mode-toggle').checked = savedMode;
            document.body.classList.toggle('dark-mode', savedMode);

            document.getElementById('start-date').value = new Date().toISOString().substring(0, 10);

            document.getElementById('jump-cycle-freq').addEventListener('input', updateJumpDaySelector);

            loadLastConfiguration();
            renderSavedQuadrants();

            // Atajos de teclado para deshacer/rehacer
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                    undo();
                    e.preventDefault();
                }
                if ((e.ctrlKey || e.metaKey) && e.key === 'y') {
                    redo();
                    e.preventDefault();
                }
            });

            showNotification("‚úÖ V3.7 cargado: Historial (Ctrl+Z/Y) y UI de Reglas Finales.", 'info');
        };

    </script>

</body>

</html>