<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Cuadrantes Din√°mico (con Fechas)</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f4f8;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.15);
        }

        h1 {
            color: #0077b6;
            border-bottom: 3px solid #0077b6;
            padding-bottom: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        /* Layout Principal */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .panel {
            background-color: #e6f7ff;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #b3e5fc;
            margin-bottom: 10px;
        }

        .panel h2 {
            margin-top: 0;
            color: #0077b6;
        }

        .flex-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        /* Controles espec√≠ficos */
        label {
            font-weight: 600;
            font-size: 0.9em;
        }

        input[type="number"],
        input[type="text"],
        input[type="date"],
        select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 0.9em;
        }

        input[type="date"] {
            flex-grow: 1;
        }

        /* Administraci√≥n de Grupos y Restricciones */
        .group-card {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .group-card textarea {
            width: 95%;
            height: 60px;
            margin-top: 5px;
            padding: 5px;
            border-radius: 3px;
            resize: vertical;
        }

        .group-list,
        .restriction-list {
            max-height: 200px;
            overflow-y: auto;
        }

        /* Botones */
        button {
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s;
            margin-left: 5px;
        }

        .btn-primary {
            background-color: #0077b6;
            color: white;
        }

        .btn-primary:hover {
            background-color: #005f93;
        }

        .btn-secondary {
            background-color: #f8f9fa;
            color: #333;
            border: 1px solid #ccc;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        /* Estilos de la Tabla */
        #slot-headers-container {
            margin-top: 10px;
        }

        #slot-headers-container input[type="text"] {
            width: 100%;
            text-align: center;
            font-weight: bold;
        }

        #resultados-container {
            margin-top: 30px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }

        th {
            background-color: #34495e;
            color: white;
            position: sticky;
            top: 0;
        }

        /* Estilos condicionales por grupo en la tabla */
        .group-hombres_cell {
            background-color: #d1e7ff;
        }

        .group-mujeres_cell {
            background-color: #ffe8d1;
        }

        .group-other_cell {
            background-color: #d4edda;
        }

        /* Resumen al final */
        .resumen {
            margin-top: 30px;
            padding: 15px;
            background-color: #f9f9f9;
            border-left: 5px solid #0077b6;
        }

        .resumen h3 {
            margin-top: 0;
            color: #0077b6;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>Generador de Cuadrantes Din√°mico (con Fechas)</h1>

        <div class="main-grid">

            <div class="panel">
                <h2>‚è±Ô∏è Secuencia de Tiempo</h2>
                <div class="flex-row">
                    <label for="semanas">Total de Filas:</label>
                    <input type="number" id="semanas" value="12" min="1" style="width: 60px;">
                </div>
                <div style="margin-bottom: 10px;">
                    <label for="start-date" style="display: block; margin-bottom: 5px;">Fecha de Inicio:</label>
                    <input type="date" id="start-date" value="2025-01-01">
                </div>
                <div class="flex-row">
                    <label for="frequency">Frecuencia (Salto en d√≠as):</label>
                    <input type="number" id="frequency" value="7" min="1" style="width: 60px;">
                    <span style="font-size: 0.8em; color: #666;">(ej. 1=Diario, 7=Semanal)</span>
                </div>

                <h2>‚öôÔ∏è Slots/Columnas</h2>
                <div class="flex-row">
                    <label for="slots">N√∫mero de Slots:</label>
                    <input type="number" id="slots" value="3" min="1" style="width: 60px;"
                        onchange="loadDisponibilidad()">
                </div>
                <div id="slot-headers-container">
                </div>

                <h2 style="margin-top: 15px;">üõë Restricciones Personalizadas</h2>
                <div id="restriction-list" class="restriction-list"></div>
                <div class="flex-row">
                    <select id="res-p1" style="flex-grow: 1;"></select>
                    <select id="res-p2" style="flex-grow: 1;"></select>
                    <button class="btn-secondary" onclick="addRestriction()">A√±adir</button>
                </div>
            </div>

            <div class="panel">
                <h2>üë• Grupos y Miembros</h2>
                <div id="group-list" class="group-list"></div>
                <div class="flex-row">
                    <input type="text" id="new-group-name" placeholder="Nombre del nuevo grupo">
                    <button class="btn-secondary" onclick="addGroup()">+ A√±adir Grupo</button>
                </div>
            </div>

            <div class="panel" style="grid-column: 3 / span 1;">
                <h2>üìÖ Disponibilidad por Slot</h2>
                <p style="font-size:0.9em;">Marca los slots a los que cada persona **puede** asistir.</p>
                <div id="disponibilidad-table-container" style="max-height: 500px; overflow-y: auto;">
                    <table id="disponibilidad-table">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn-secondary" onclick="loadDisponibilidad()">Actualizar Slots/Personas</button>
                    <button class="btn-secondary" onclick="checkAllSlots()">Marcar Todo</button>
                </div>
            </div>

        </div>

        <button class="btn-primary" style="width: 100%; font-size: 1.2em;" onclick="generarCuadrante()">üöÄ Generar
            Cuadrante Final</button>


        <div id="resultados">
        </div>

    </div>

    <script>
        // --- 1. DATOS INICIALES Y ESTRUCTURAS ---
        let GRUPOS_DATA = [
            { id: 'hombres', name: 'Hombres', members: "Javier, Jos√© Miguel, Misael, Antonio, Jetro, Mario", colorClass: 'group-hombres' },
            { id: 'mujeres', name: 'Mujeres', members: "Antonia, Fe, Luc√≠a, Ana Mari, M.J. Prua√±o, M.J. Vega, Meli, Mercedes, Neysa", colorClass: 'group-mujeres' }
        ];
        let RESTRICCIONES_DATA = [
            { p1: "Mario", p2: "Misael" }
        ];
        let SLOT_HEADERS = ["Visitador", "Acompa√±ante 1", "Acompa√±ante 2"];

        // Variables de estado din√°micas
        let PARTICIPANTES = [];
        let PARTICIPANTES_MAP = new Map();
        let disponibilidadMap = new Map();
        let contadorVisitas = new Map();
        let ultimaVisita = new Map();
        let semanaActual = 0;

        // Funci√≥n de inicializaci√≥n
        const inicializarDatos = () => {
            PARTICIPANTES = [];
            contadorVisitas.clear();
            ultimaVisita.clear();
            semanaActual = 0;

            GRUPOS_DATA.forEach(group => {
                const members = group.members.split(',').map(m => m.trim()).filter(m => m.length > 0);
                members.forEach(p => {
                    if (!PARTICIPANTES.includes(p)) {
                        PARTICIPANTES.push(p);
                        PARTICIPANTES_MAP.set(p, { groupId: group.id, colorClass: group.colorClass });
                        contadorVisitas.set(p, 0);
                        ultimaVisita.set(p, -1);
                    }
                });
            });
        };

        const random = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;


        // --- 2. GESTI√ìN DE INTERFAZ (DOM) ---

        const getActiveParticipants = () => {
            inicializarDatos();
            return PARTICIPANTES;
        };

        /** Renderiza los inputs para cambiar el nombre de los slots. */
        function renderSlotHeaders() {
            const container = document.getElementById('slot-headers-container');
            const slots = parseInt(document.getElementById('slots').value);
            container.innerHTML = '';

            while (SLOT_HEADERS.length < slots) {
                SLOT_HEADERS.push(`Slot ${SLOT_HEADERS.length + 1}`);
            }
            SLOT_HEADERS = SLOT_HEADERS.slice(0, slots);

            const gridStyle = `display: grid; grid-template-columns: repeat(${slots}, 1fr); gap: 5px;`;
            container.style = gridStyle;

            SLOT_HEADERS.forEach((header, index) => {
                const input = document.createElement('input');
                input.type = 'text';
                input.value = header;
                input.placeholder = `Slot ${index + 1}`;
                input.onchange = (e) => SLOT_HEADERS[index] = e.target.value;
                container.appendChild(input);
            });
        }

        /** Carga la tabla de disponibilidad con las personas y slots actuales. */
        function loadDisponibilidad() {
            const slots = parseInt(document.getElementById('slots').value);
            const activeParticipants = getActiveParticipants();
            const table = document.getElementById('disponibilidad-table');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');

            if (isNaN(slots) || slots < 1) return;

            renderSlotHeaders();

            // 1. Construir Encabezado (Slots)
            let headerHTML = '<tr><th>Persona</th>';
            SLOT_HEADERS.forEach(() => {
                headerHTML += `<th></th>`; // Se rellena con el nombre del slot
            });
            thead.innerHTML = headerHTML + '</tr>';
            // Poner los nombres de los slots en la segunda fila (para mejor visualizaci√≥n)
            const slotNamesRow = document.createElement('tr');
            slotNamesRow.innerHTML = `<th></th>` + SLOT_HEADERS.map(name => `<th>${name}</th>`).join('');
            thead.appendChild(slotNamesRow);

            // 2. Construir Cuerpo (Personas y Checkboxes)
            let bodyHTML = '';
            activeParticipants.forEach(p => {
                bodyHTML += `<tr><td style="font-weight: bold;">${p}</td>`;
                for (let i = 1; i <= slots; i++) {
                    const isChecked = disponibilidadMap.get(p)?.has(i) ?? true;
                    bodyHTML += `
                        <td>
                            <input type="checkbox" class="disp-check" 
                                onchange="toggleDisponibilidad('${p}', ${i}, this.checked)" ${isChecked ? 'checked' : ''}>
                        </td>
                    `;
                }
                bodyHTML += '</tr>';
            });
            tbody.innerHTML = bodyHTML;

            updateRestrictionSelects(); // Refresca los selects
        }

        /** Controla el cambio de estado de un checkbox de disponibilidad. */
        function toggleDisponibilidad(person, slot, isChecked) {
            if (!disponibilidadMap.has(person)) {
                // Inicializa el Set con todos los slots marcados si es la primera vez que se toca
                const slots = parseInt(document.getElementById('slots').value);
                const initialSet = new Set();
                for (let i = 1; i <= slots; i++) { initialSet.add(i); }
                disponibilidadMap.set(person, initialSet);
            }

            if (isChecked) {
                disponibilidadMap.get(person).add(slot);
            } else {
                disponibilidadMap.get(person).delete(slot);
            }
        }

        /** Marca todos los slots disponibles (opci√≥n). */
        function checkAllSlots() {
            const slots = parseInt(document.getElementById('slots').value);
            getActiveParticipants().forEach(p => {
                const availableSlots = new Set();
                for (let i = 1; i <= slots; i++) { availableSlots.add(i); }
                disponibilidadMap.set(p, availableSlots);
            });
            loadDisponibilidad(); // Refresca la interfaz
        }


        // --- 3. L√ìGICA DE ASIGNACI√ìN CON MANEJO DE FECHAS ---

        /** Funci√≥n principal para generar el cuadrante. */
        function generarCuadrante() {
            inicializarDatos();

            const semanasTotales = parseInt(document.getElementById('semanas').value);
            const slots = parseInt(document.getElementById('slots').value);
            const startDateStr = document.getElementById('start-date').value;
            const frequency = parseInt(document.getElementById('frequency').value);

            const startDate = new Date(startDateStr);
            if (isNaN(startDate.getTime())) {
                alert("Por favor, selecciona una Fecha de Inicio v√°lida.");
                return;
            }

            if (isNaN(semanasTotales) || semanasTotales <= 0 || isNaN(slots) || slots <= 0 || isNaN(frequency) || frequency <= 0) {
                alert("Por favor, introduce n√∫meros v√°lidos en la configuraci√≥n de Slots y Secuencia.");
                return;
            }

            const cuadrante = [];

            // Generaci√≥n fila por fila
            for (let i = 0; i < semanasTotales; i++) {
                semanaActual++; // Contador interno para la rotaci√≥n (1, 2, 3...)

                // C√°lculo de la fecha exacta usando el objeto Date (maneja a√±os bisiestos/meses)
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + (i * frequency));

                // Formateo de la fecha para la tabla (DD/MM/YYYY)
                const etiquetaTiempo = currentDate.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });

                const semanaSlots = [];
                let personasAsignadasEstaSemana = new Set();

                // Generaci√≥n slot por slot
                for (let slot = 1; slot <= slots; slot++) {
                    const asignacion = asignarSlot(slot, personasAsignadasEstaSemana);
                    semanaSlots.push(asignacion);

                    if (asignacion.person && asignacion.person !== 'VAC√çO') {
                        personasAsignadasEstaSemana.add(asignacion.person);

                        // Actualizar contadores
                        contadorVisitas.set(asignacion.person, (contadorVisitas.get(asignacion.person) || 0) + 1);
                        ultimaVisita.set(asignacion.person, semanaActual);
                    }
                }
                cuadrante.push({ etiquetaTiempo: etiquetaTiempo, slots: semanaSlots });
            }

            mostrarResultados(cuadrante, slots);
        }

        /** Asigna una persona al slot actual bas√°ndose en disponibilidad y reglas. */
        function asignarSlot(slot, personasAsignadasEstaSemana) {

            // 1. Crear la lista de candidatos disponibles
            let candidatos = PARTICIPANTES.filter(p =>
                // A. No ha sido asignado ya esta semana
                !personasAsignadasEstaSemana.has(p) &&
                // B. Est√° disponible para este slot
                (disponibilidadMap.get(p)?.has(slot) ?? true) // Si no est√° en el mapa, asumimos disponible
            );

            // 2. Aplicar Restricciones Duras
            for (const p of personasAsignadasEstaSemana) {
                RESTRICCIONES_DATA.forEach(r => {
                    if (r.p1 === p) { candidatos = candidatos.filter(c => c !== r.p2); }
                    if (r.p2 === p) { candidatos = candidatos.filter(c => c !== r.p1); }
                });
            }

            // 3. Ordenar para elegir al mejor (rotaci√≥n: menos visitas, m√°s tiempo sin ir)
            candidatos.sort((p1, p2) => {
                const visitas1 = contadorVisitas.get(p1) || 0;
                const visitas2 = contadorVisitas.get(p2) || 0;
                const tiempoSinIr1 = semanaActual - (ultimaVisita.get(p1) || -1);
                const tiempoSinIr2 = semanaActual - (ultimaVisita.get(p2) || -1);

                // Prioridad 1: Menos visitas totales
                const diffVisitas = visitas1 - visitas2;
                if (diffVisitas !== 0) return diffVisitas;

                // Prioridad 2: Mayor tiempo sin ir 
                return tiempoSinIr2 - tiempoSinIr1;
            });

            // 4. Asignar
            const assignedPerson = candidatos[0];
            if (assignedPerson) {
                return { person: assignedPerson, groupName: PARTICIPANTES_MAP.get(assignedPerson).groupId };
            } else {
                return { person: 'VAC√çO', groupName: 'empty' };
            }
        }

        // --- 4. RENDERIZACI√ìN DE RESULTADOS ---

        /** Renderiza la tabla de slots y el resumen. */
        function mostrarResultados(cuadrante, slots) {
            const resultadosDiv = document.getElementById('resultados');

            // --- 1. Construcci√≥n de la Tabla (Cuadrante) ---
            let tablaHTML = "<div id='cuadrante-table-container'><table><thead><tr><th>Fecha</th>";
            SLOT_HEADERS.forEach(header => {
                tablaHTML += `<th>${header}</th>`;
            });
            tablaHTML += "</tr></thead><tbody>";

            cuadrante.forEach(fila => {
                tablaHTML += `<tr><td style="font-weight: bold;">${fila.etiquetaTiempo}</td>`;
                fila.slots.forEach(slot => {
                    const groupClass = slot.groupName.replace(/\s/g, '_') + '_cell';
                    tablaHTML += `<td class="${groupClass}">${slot.person}</td>`;
                });
                tablaHTML += "</tr>";
            });

            tablaHTML += "</tbody></table></div>";

            // --- 2. Resumen de Frecuencia (al final) ---
            let resumenHTML = "<div class='resumen'><h3>Resumen de Frecuencia (Visitas Totales)</h3><ul>";
            const resumenVisitas = Array.from(contadorVisitas.entries())
                .sort(([, v1], [, v2]) => v2 - v1);
            resumenVisitas.forEach(([nombre, visitas]) => {
                if (visitas > 0) resumenHTML += `<li><strong>${nombre}</strong>: ${visitas} visitas</li>`;
            });
            resumenHTML += "</ul></div>";

            // Se inserta la tabla primero y luego el resumen
            resultadosDiv.innerHTML = tablaHTML + resumenHTML;
        }

        // --- FUNCIONES AUXILIARES DE INTERFAZ (GRUPOS Y RESTRICCIONES) ---
        // (Mantener el resto de las funciones de administraci√≥n de grupos y restricciones tal como estaban, sin cambios en la l√≥gica)

        function renderGroups() {
            const listDiv = document.getElementById('group-list');
            listDiv.innerHTML = '';

            GRUPOS_DATA.forEach((group) => {
                const card = document.createElement('div');
                card.className = `group-card ${group.colorClass}`;

                const safeName = group.name.replace(/"/g, '&quot;');

                card.innerHTML = `
                    <div class="flex-row" style="justify-content:space-between;">
                        <input type="text" value="${safeName}" onchange="renameGroup('${group.id}', this.value)" style="font-weight:bold; border:none; background:transparent;">
                        <button class="btn-danger" style="margin-left:auto; padding: 5px 10px;" onclick="removeGroup('${group.id}')">Eliminar</button>
                    </div>
                    <label style="font-size: 0.9em; display:block; margin-top: 5px;">Miembros (coma):</label>
                    <textarea onchange="updateGroupMembers('${group.id}', this.value)">${group.members}</textarea>
                `;
                listDiv.appendChild(card);
            });
            updateRestrictionSelects();
        }

        function addGroup() {
            const newNameInput = document.getElementById('new-group-name');
            const name = newNameInput.value.trim() || `Grupo ${GRUPOS_DATA.length + 1}`;
            newNameInput.value = '';

            const newId = `group_${Date.now()}`;
            GRUPOS_DATA.push({
                id: newId,
                name: name,
                members: '',
                colorClass: 'group-other'
            });
            renderGroups();
            loadDisponibilidad();
        }

        function renameGroup(id, newName) {
            const group = GRUPOS_DATA.find(g => g.id === id);
            if (group) group.name = newName.trim();
            renderGroups();
        }

        function updateGroupMembers(id, membersText) {
            const group = GRUPOS_DATA.find(g => g.id === id);
            if (group) group.members = membersText;
            loadDisponibilidad();
        }

        function removeGroup(id) {
            if (GRUPOS_DATA.length <= 1) {
                alert("Debe haber al menos un grupo.");
                return;
            }
            GRUPOS_DATA = GRUPOS_DATA.filter(g => g.id !== id);
            renderGroups();
            loadDisponibilidad();
        }

        function updateRestrictionSelects() {
            getActiveParticipants();
            const selects = [document.getElementById('res-p1'), document.getElementById('res-p2')];

            selects.forEach(select => {
                select.innerHTML = '<option value="">(Seleccionar)</option>';
                PARTICIPANTES.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p;
                    option.textContent = p;
                    select.appendChild(option);
                });
            });
            renderRestrictions();
        }

        function addRestriction() {
            const p1 = document.getElementById('res-p1').value;
            const p2 = document.getElementById('res-p2').value;

            if (!p1 || !p2 || p1 === p2) {
                alert("Selecciona dos personas diferentes.");
                return;
            }

            const [minP, maxP] = p1 < p2 ? [p1, p2] : [p2, p1];

            const exists = RESTRICCIONES_DATA.some(r =>
                (r.p1 === minP && r.p2 === maxP)
            );

            if (!exists) {
                RESTRICCIONES_DATA.push({ p1: minP, p2: maxP });
                renderRestrictions();
            }
        }

        function removeRestriction(p1, p2) {
            const [minP, maxP] = p1 < p2 ? [p1, p2] : [p2, p1];

            RESTRICCIONES_DATA = RESTRICCIONES_DATA.filter(r =>
                !(r.p1 === minP && r.p2 === maxP)
            );
            renderRestrictions();
        }

        function renderRestrictions() {
            const listDiv = document.getElementById('restriction-list');
            listDiv.innerHTML = '';

            if (RESTRICCIONES_DATA.length === 0) {
                listDiv.innerHTML = '<p style="font-size: 0.9em; color: #666;">No hay restricciones activas.</p>';
                return;
            }

            RESTRICCIONES_DATA.forEach(r => {
                const div = document.createElement('div');
                div.className = 'flex-row';
                div.style.justifyContent = 'space-between';
                div.innerHTML = `
                    <span>üõë ${r.p1} y ${r.p2}</span>
                    <button class="btn-danger" style="padding: 5px 10px;" onclick="removeRestriction('${r.p1}', '${r.p2}')">X</button>
                `;
                listDiv.appendChild(div);
            });
        }

        // --- INICIALIZACI√ìN ---
        window.onload = () => {
            renderGroups();
            renderRestrictions();
            // Establece la fecha de inicio por defecto a la fecha de hoy
            document.getElementById('start-date').valueAsDate = new Date();
            loadDisponibilidad();
            checkAllSlots();
        };
    </script>

</body>

</html>