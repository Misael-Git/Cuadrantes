<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Cuadrantes Autom√°tico</title>
    <style>
        /* --- ESTILOS BASE Y LAYOUT --- */
        :root {
            /* Modo Claro */
            --bg-color: #f0f4f8;
            --container-bg: white;
            --panel-bg: #e6f7ff;
            --panel-border: #b3e5fc;
            --sub-panel-bg: white;
            --primary-color: #0077b6;
            --primary-light: #4fbcdb;
            --text-color: #333;
            --sub-text-color: #666;
            --border-color: #ccc;
            --table-header-bg: #34495e;
            --table-header-text: white;
            --notification-info-bg: #cce5ff;
            --notification-info-text: #004085;
            --shadow: 0 4px 25px rgba(0, 0, 0, 0.15);
            --group-card-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);

            /* Estilos de botones */
            --btn-primary-bg: var(--primary-color);
            --btn-primary-text: white;
            --btn-secondary-bg: #f0f0f0;
            --btn-secondary-text: #333;
            --btn-danger-bg: #e74c3c;
            --btn-danger-text: white;
        }

        /* --- ESTILOS MODO OSCURO --- */
        body.dark-mode {
            --bg-color: #1e1e2e;
            --container-bg: #292a3c;
            --panel-bg: #32354a;
            --panel-border: #4d4f68;
            --sub-panel-bg: #292a3c;
            --primary-color: #6ed3cf;
            --primary-light: #7bfffb;
            --text-color: #f0f0f0;
            --sub-text-color: #b0b0b0;
            --border-color: #4d4f68;
            --table-header-bg: #1e2029;
            --table-header-text: #6ed3cf;
            --notification-info-bg: #4d4f68;
            --notification-info-text: #9fe2d7;
            --shadow: 0 4px 25px rgba(0, 0, 0, 0.4);
            --group-card-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);

            /* Estilos de botones (Modo Oscuro) */
            --btn-primary-bg: var(--primary-color);
            --btn-primary-text: var(--table-header-bg);
            --btn-secondary-bg: #4d4f68;
            --btn-secondary-text: var(--text-color);
            --btn-danger-bg: #c0392b;
            --btn-danger-text: white;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            padding: 20px;
            color: var(--text-color);
            transition: background-color 0.4s, color 0.4s;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--sub-panel-bg);
            padding: 30px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            transition: background 0.4s, box-shadow 0.4s;
        }

        h1 {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        /* Layout Principal: 3 columnas de igual ancho */
        .main-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .sub-panel {
            background-color: var(--panel-bg);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid var(--panel-border);
            transition: background-color 0.4s, border-color 0.4s;
        }

        h2 {
            margin-top: 0;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .flex-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .flex-col {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        /* Controles espec√≠ficos: TODOS REDONDEADOS */
        label {
            font-weight: 600;
            font-size: 0.9em;
            color: var(--text-color);
        }

        input[type="number"],
        input[type="text"],
        input[type="date"],
        select,
        textarea,
        input[type="range"] {
            padding: 8px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            font-size: 0.9em;
            background-color: var(--sub-panel-bg);
            color: var(--text-color);
            transition: background-color 0.4s, color 0.4s, border-color 0.4s, box-shadow 0.2s;
        }

        select[multiple] {
            height: 100px;
        }

        /* Estilos de botones: TODOS REDONDEADOS y decorados */
        button {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.1s, box-shadow 0.2s;
        }

        button:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background-color: var(--btn-primary-bg);
            color: var(--btn-primary-text);
            box-shadow: 0 4px var(--primary-light);
        }

        .btn-primary:hover {
            background-color: var(--primary-light);
        }

        .btn-secondary {
            background-color: var(--btn-secondary-bg);
            color: var(--btn-secondary-text);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: var(--border-color);
        }

        .btn-danger {
            background-color: var(--btn-danger-bg);
            color: var(--btn-danger-text);
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.8em;
            border-radius: 4px;
        }

        /* Grupos y Miembros (Dise√±o Restaurado) */
        .group-card {
            padding: 10px;
            margin-bottom: 10px;
            border: 2px solid var(--primary-light);
            border-radius: 8px;
            box-shadow: var(--group-card-shadow);
            background-color: var(--sub-panel-bg);
            transition: all 0.4s;
        }

        .group-card textarea {
            min-height: 80px;
            resize: none;
            /* APLICADO: Deshabilita el redimensionamiento */
            width: 95%;
        }

        /* Lista de Presets (Dise√±o Restaurado) */
        #presets-list {
            list-style: none;
            padding: 0;
            margin: 10px 0;
        }

        #presets-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px dashed var(--border-color);
            font-size: 0.9em;
        }

        /* Tabs para Modos de Fila */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--tab-border);
            margin-bottom: 15px;
        }

        .tab-button {
            padding: 10px 15px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            background: transparent;
            color: var(--sub-text-color);
            font-weight: 600;
            transition: all 0.3s;
            border-radius: 6px 6px 0 0;
        }

        .tab-button.active {
            border: 1px solid var(--tab-border);
            border-bottom: 1px solid var(--panel-bg);
            background-color: var(--panel-bg);
            color: var(--primary-color);
        }

        .tab-content {
            border-top: 1px solid var(--tab-border);
            padding-top: 15px;
            margin-top: -1px;
        }

        /* Contenedor de Disponibilidad con scroll vertical y horizontal (MODIFICADO) */
        #disponibilidad-view {
            max-height: 250px;
            overflow-y: auto;
            overflow-x: auto;
            /* APLICADO: Scroll Horizontal */
            padding-right: 5px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--sub-panel-bg);
        }

        /* Estilos de la Tabla Base (Para Disponibilidad) */
        #disponibilidad-view table {
            min-width: 100%;
            /* Asegura que la tabla se mantenga dentro del contenedor, pero pueda desbordar para el scroll */
        }

        #disponibilidad-view th,
        #disponibilidad-view td {
            min-width: 60px;
            /* Ancho m√≠nimo para las celdas de slot */
        }

        /* Estilos de la Tabla de Resultados */
        th,
        td {
            border: 1px solid var(--border-color);
            padding: 10px;
            text-align: center;
            background-color: var(--sub-panel-bg);
            transition: background-color 0.4s, border-color 0.4s;
            white-space: nowrap;
        }

        th {
            background-color: var(--table-header-bg);
            color: var(--table-header-text);
        }

        .conflict_cell_colored {
            background-color: #ffcccc !important;
            font-weight: bold;
            color: #cc0000;
        }

        /* Estilos de Control de Ancho (Mejorado) */
        .width-control-bar {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 10px 0 20px 0;
            padding: 10px;
            background: var(--panel-bg);
            border-radius: 8px;
            border: 1px solid var(--panel-border);
        }

        .width-control-bar input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .width-control-bar input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }

        /* Notificaci√≥n Flotante */
        #notification-box {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            padding: 10px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            font-weight: bold;
            display: none;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            opacity: 0.95;
            transition: all 0.3s;
            max-width: 600px;
            text-align: center;
        }

        /* BOT√ìN DE MODO OSCURO (CORRECCI√ìN EST√âTICA) */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--btn-secondary-bg);
            transition: .4s;
            border-radius: 34px;
            border: 1px solid var(--border-color);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: var(--primary-color);
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
        }

        input:checked+.slider {
            background-color: var(--primary-light);
        }

        input:focus+.slider {
            box-shadow: 0 0 1px var(--primary-color);
        }

        input:checked+.slider:before {
            transform: translateX(26px);
            background-color: white;
        }

        /* Staging de Obligaciones */
        #required-people-staging {
            min-height: 50px;
            padding: 5px;
            border: 1px dashed var(--border-color);
            border-radius: 6px;
            background-color: var(--sub-panel-bg);
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: center;
        }

        .staged-person {
            background-color: var(--primary-light);
            color: var(--table-header-bg);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            gap: 5px;
        }
    </style>
</head>

<body>
    <div id="notification-box" class="info"></div>
    <div class="theme-toggle">
        <span style="font-weight: 600; font-size: 0.9em; color: var(--text-color);">Modo Oscuro</span>
        <label class="switch">
            <input type="checkbox" id="dark-mode-toggle" onchange="toggleDarkMode()">
            <span class="slider"></span>
        </label>
    </div>

    <div class="container">
        <h1>Generador de Cuadrantes Autom√°tico</h1>

        <div class="main-grid">

            <div class="col-left">

                <div class="sub-panel">
                    <h2>‚ÜîÔ∏è Filas</h2>

                    <div class="flex-row">
                        <label for="semanas">Total de Filas (Turnos):</label>
                        <input type="number" id="semanas" value="12" min="1" style="width: 60px;">
                    </div>

                    <div class="tabs">
                        <button class="tab-button active" onclick="changeRowMode('date', this)">Modo Fecha</button>
                        <button class="tab-button" onclick="changeRowMode('turn', this)">Modo Turnos</button>
                        <button class="tab-button" onclick="changeRowMode('time_slots', this)">Modo Tramos</button>
                    </div>

                    <div id="row-mode-content">
                        <div id="row-mode-date" class="tab-content" style="display: block;">
                            <div style="margin-bottom: 10px;">
                                <label for="start-date" style="display: block; margin-bottom: 5px;">Fecha de
                                    Inicio:</label>
                                <input type="date" id="start-date" value="2025-01-01">
                            </div>
                            <div class="flex-row">
                                <label for="frequency">Frecuencia (Salto en d√≠as):</label>
                                <input type="number" id="frequency" value="7" min="1" style="width: 60px;">
                            </div>
                        </div>

                        <div id="row-mode-turn" class="tab-content" style="display: none;">
                            <div class="flex-row">
                                <label for="turn-label">Etiqueta Base:</label>
                                <input type="text" id="turn-label" value="Turno" style="flex-grow: 1;">
                            </div>
                            <div class="flex-row">
                                <label for="turn-format">Formato:</label>
                                <select id="turn-format" style="flex-grow: 1;">
                                    <option value="numeric">1, 2, 3...</option>
                                    <option value="alphabetic">A, B, C...</option>
                                </select>
                            </div>
                        </div>

                        <div id="row-mode-time-slots" class="tab-content" style="display: none;">
                            <div class="flex-row">
                                <label for="time-slot-days">D√≠as a Repetir (ej. L, M, X):</label>
                                <input type="text" id="time-slot-days" value="Lunes, Martes, Mi√©rcoles"
                                    style="flex-grow: 1;">
                            </div>
                            <div class="flex-row">
                                <label for="time-slot-times">Tramos Horarios (ej. 10:00, 17:00):</label>
                                <input type="text" id="time-slot-times" value="10:00, 17:00" style="flex-grow: 1;">
                            </div>
                            <p style="font-size:0.85em; color:var(--sub-text-color); margin-top:-5px;">Una fila por cada
                                tramo, se repiten por los d√≠as definidos.</p>
                        </div>

                    </div>

                </div>

                <div class="sub-panel" style="margin-bottom: 0;">
                    <h2>‚öôÔ∏è Slots/Columnas</h2>
                    <div class="flex-row">
                        <label for="slots">N√∫mero de Slots:</label>
                        <input type="number" id="slots" value="3" min="1" style="width: 60px;"
                            onchange="handleSlotsChange()">
                    </div>
                    <div id="slot-headers-container">
                    </div>
                </div>
            </div>

            <div class="col-center">

                <div class="sub-panel">
                    <h2>üë• Grupos y Miembros</h2>
                    <p style="font-size: 0.9em; color: var(--sub-text-color); margin-top: -10px;">Define los grupos y
                        sus miembros.</p>
                    <div id="group-list" class="group-list" onchange="loadDisponibilidad()"></div>
                    <div class="flex-row" style="margin-top: 15px;">
                        <input type="text" id="new-group-name" placeholder="Nombre del nuevo grupo">
                        <button class="btn-secondary btn-small" onclick="addGroup()">+ A√±adir Grupo</button>
                    </div>
                </div>

                <div class="sub-panel" style="margin-bottom: 0;">
                    <h2>üíæ Gesti√≥n de Configuraciones</h2>
                    <p style="font-size: 0.9em; margin-top: -10px; color: var(--sub-text-color);">Presets Locales y
                        Archivos</p>
                    <div class="flex-row" style="margin-bottom: 5px;">
                        <input type="text" id="preset-name-input" placeholder="Nombre para guardar preset"
                            style="flex-grow: 1;">
                        <button class="btn-primary" onclick="saveConfiguration()">Guardar Preset</button>
                    </div>

                    <ul id="presets-list">
                    </ul>

                    <div class="btn-group">
                        <button class="btn-secondary" onclick="downloadConfiguration()">‚¨áÔ∏è Descargar Archivo
                            (.json)</button>
                        <input type="file" id="upload-file" accept=".json" style="display: none;"
                            onchange="uploadConfiguration(event)">
                        <button class="btn-secondary" onclick="document.getElementById('upload-file').click()">‚¨ÜÔ∏è Cargar
                            Archivo (.json)</button>
                    </div>
                </div>
            </div>

            <div class="col-right">

                <div class="sub-panel">
                    <h2>ü§ù Obligaciones (Inclusi√≥n M√∫ltiple)</h2>
                    <div id="obligation-list" class="obligation-list" style="max-height: 100px; overflow-y: auto;">
                    </div>
                    <p style="font-size: 0.85em; color: var(--sub-text-color); margin-top: 10px;">**P1** solo si est√°
                        **P2, P3...**</p>
                    <div style="margin-top: 5px; border-top: 1px solid var(--border-color); padding-top: 10px;">
                        <div class="flex-row">
                            <label>Persona Obligada (P1):</label>
                            <select id="obl-p1" style="flex-grow: 1;"></select>
                        </div>
                        <div class="flex-row">
                            <label>Requisito a A√±adir:</label>
                            <select id="obl-p2-single-select" style="flex-grow: 1;"></select>
                            <button class="btn-secondary btn-small" onclick="stageRequiredPerson()">+ Staging</button>
                        </div>
                        <div id="required-people-staging" style="margin-bottom: 10px;">
                        </div>
                        <button class="btn-primary" style="width: 100%;" onclick="addObligation()"
                            id="add-obligation-final-btn" disabled>A√±adir Obligaci√≥n Final</button>
                    </div>
                </div>

                <div class="sub-panel">
                    <h2>üõë Restricciones (Exclusi√≥n)</h2>
                    <div id="restriction-list" class="restriction-list" style="max-height: 100px; overflow-y: auto;">
                    </div>
                    <div class="flex-row" style="margin-top: 15px;">
                        <select id="res-p1" style="flex-grow: 1;"></select>
                        <select id="res-p2" style="flex-grow: 1;"></select>
                        <button class="btn-secondary btn-small" onclick="addRestriction()">A√±adir</button>
                    </div>
                </div>

                <div class="sub-panel">
                    <h2>üìÖ Disponibilidad</h2>
                    <div class="flex-row" style="justify-content: space-between;">
                        <label for="disp-mode-toggle" style="margin: 0;">Modo de Disponibilidad:</label>
                        <label class="switch" style="margin: 0;">
                            <input type="checkbox" id="disp-mode-toggle" onchange="toggleDisponibilidadMode()">
                            <span class="slider" style="width: 60px;"></span>
                        </label>
                        <span id="disp-mode-label"
                            style="font-weight: bold; min-width: 60px; text-align: right;">Grupo</span>
                    </div>

                    <p style="font-size:0.9em; margin-top: 10px; color: var(--sub-text-color);">Slots disponibles por
                        <span id="disp-target-label" style="font-weight: bold;">grupo</span>.</p>

                    <div id="disponibilidad-view">
                        <div id="disponibilidad-table-container">
                            <table id="disponibilidad-table">
                                <thead></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div id="disponibilidad-per-person-list" style="display:none;">
                        </div>
                    </div>

                    <div style="margin-top: 10px; display: flex; justify-content: flex-start;">
                        <button class="btn-secondary btn-small" onclick="checkAllSlots()">Marcar Todo</button>
                    </div>
                </div>

                <div class="sub-panel" style="margin-bottom: 0;">
                    <h2>üìä Opciones de Generaci√≥n</h2>
                    <div style="margin-bottom: 10px;">
                        <label for="priority-mode">Prioridad de Asignaci√≥n:</label>
                        <select id="priority-mode" style="width: 100%; margin-top: 5px;">
                            <option value="frecuencia">Priorizar Distribuci√≥n Frecuente</option>
                            <option value="pareja">Priorizar Diversidad de Parejas</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 0; display: flex; align-items: center; justify-content: space-between;">
                        <label for="same-group-only">Solo Personas del Mismo Grupo Juntas</label>
                        <input type="checkbox" id="same-group-only">
                    </div>
                </div>
            </div>

        </div>

        <button class="btn-primary" style="width: 100%; font-size: 1.2em;" onclick="generarCuadrante()">üöÄ Generar
            Cuadrante Final</button>


        <div id="resultados">
        </div>

    </div>

    <script>
        // --- 1. DATOS INICIALES Y ESTRUCTURAS ---
        const LOCAL_STORAGE_KEY = 'cuadrante_presets';
        let GRUPOS_DATA = [
            { id: 'hombres', name: 'Hombres', members: "Javier, Jos√© Miguel, Misael, Antonio, Jetro, Mario", colorClass: 'group-hombres' },
            { id: 'mujeres', name: 'Mujeres', members: "Antonia, Fe, Luc√≠a, Ana Mari, M.J. Prua√±o, M.J. Vega, Meli, Mercedes, Neysa", colorClass: 'group-mujeres' }
        ];
        let RESTRICCIONES_DATA = [
            { p1: "Mario", p2: "Misael" }
        ];
        // Obligaciones: { requiredFor: 'P1', requiredPeople: ['P2', 'P3'] }
        let OBLIGACIONES_DATA = [
            { requiredFor: "Jos√© Miguel", requiredPeople: ["Javier", "Mario"] }
        ];
        let SLOT_HEADERS = ["Visitador", "Acompa√±ante 1", "Acompa√±ante 2"];

        let PARTICIPANTES = [];
        let PARTICIPANTES_MAP = new Map();

        let disponibilidadMap = new Map();
        let isDisponibilidadPerPerson = false;

        let currentRowMode = 'date'; // 'date', 'turn', 'time_slots'

        let contadorVisitas = new Map();
        let ultimaVisita = new Map();
        let ultimaPareja = new Map();
        let grupoVisitas = new Map();
        let semanaActual = 0;
        let ULTIMO_CUADRANTE_GENERADO = [];

        const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';

        const inicializarDatos = () => {
            PARTICIPANTES = [];
            contadorVisitas.clear();
            ultimaVisita.clear();
            ultimaPareja.clear();
            grupoVisitas.clear();
            semanaActual = 0;

            GRUPOS_DATA.forEach(group => {
                const members = group.members.split(',').map(m => m.trim()).filter(m => m.length > 0);
                group.id = group.name.toLowerCase().replace(/\s/g, '_').replace(/[^a-z0-9_]/g, '');
                group.colorClass = `group-${group.id}`;

                grupoVisitas.set(group.id, { count: 0, members: members.length });
                members.forEach(p => {
                    if (!PARTICIPANTES.includes(p)) {
                        PARTICIPANTES.push(p);
                        PARTICIPANTES_MAP.set(p, { groupId: group.id, colorClass: group.colorClass });
                        contadorVisitas.set(p, 0);
                        ultimaVisita.set(p, -1);
                        ultimaPareja.set(p, null);
                    }
                });
            });
        };

        const getActiveParticipants = () => {
            inicializarDatos();
            return PARTICIPANTES;
        };

        // --- 2. GESTI√ìN DE INTERFAZ (DOM) y MODO OSCURO ---

        function toggleDarkMode() {
            const isDarkMode = document.getElementById('dark-mode-toggle').checked;
            document.body.classList.toggle('dark-mode', isDarkMode);
            localStorage.setItem('dark-mode', isDarkMode);
        }

        /** Muestra un mensaje en el recuadro de notificaciones. */
        function showNotification(message, type = 'info') {
            const box = document.getElementById('notification-box');
            box.innerHTML = message;
            box.className = '';
            box.classList.add(type);
            box.style.display = 'block';

            clearTimeout(box.timeoutId);
            box.timeoutId = setTimeout(() => {
                box.style.display = 'none';
            }, 5000);
        }

        // --- TABS DE MODO DE FILA ---
        function changeRowMode(mode, button) {
            currentRowMode = mode;
            const contents = document.querySelectorAll('.tab-content');
            const buttons = document.querySelectorAll('.tab-button');

            contents.forEach(c => c.style.display = 'none');
            buttons.forEach(b => b.classList.remove('active'));

            document.getElementById(`row-mode-${mode}`).style.display = 'block';
            button.classList.add('active');

            localStorage.setItem('row-mode', mode);
            showNotification(`Modo de filas cambiado a **${button.textContent}**.`, 'info');
        }

        // --- GESTI√ìN DE SLOTS Y DISPONIBILIDAD ---
        function renderSlotHeaders() {
            const container = document.getElementById('slot-headers-container');
            const slots = parseInt(document.getElementById('slots').value);
            container.innerHTML = '';

            while (SLOT_HEADERS.length < slots) {
                SLOT_HEADERS.push(`Slot ${SLOT_HEADERS.length + 1}`);
            }
            SLOT_HEADERS = SLOT_HEADERS.slice(0, slots);

            SLOT_HEADERS.forEach((header, index) => {
                const input = document.createElement('input');
                input.type = 'text';
                input.value = header;
                input.placeholder = `Slot ${index + 1}`;
                input.onchange = (e) => {
                    SLOT_HEADERS[index] = e.target.value;
                    loadDisponibilidad();
                };
                container.appendChild(input);
            });
        }

        function toggleDisponibilidadMode() {
            isDisponibilidadPerPerson = document.getElementById('disp-mode-toggle').checked;

            document.getElementById('disp-mode-label').textContent = isDisponibilidadPerPerson ? 'Persona' : 'Grupo';
            document.getElementById('disp-target-label').textContent = isDisponibilidadPerPerson ? 'persona' : 'grupo';

            document.getElementById('disponibilidad-table-container').style.display = isDisponibilidadPerPerson ? 'none' : 'block';
            document.getElementById('disponibilidad-per-person-list').style.display = isDisponibilidadPerPerson ? 'block' : 'none';

            loadDisponibilidad();
            localStorage.setItem('disp-mode', isDisponibilidadPerPerson ? 'per-person' : 'per-group');
            showNotification(`Modo de Disponibilidad cambiado a: **${isDisponibilidadPerPerson ? 'Por Persona' : 'Por Grupo'}**`, 'info');
        }

        function handleSlotsChange() {
            disponibilidadMap.clear();
            loadDisponibilidad();
        }

        function loadDisponibilidad() {
            const slots = parseInt(document.getElementById('slots').value);

            if (isNaN(slots) || slots < 1) return;

            renderSlotHeaders();

            if (isDisponibilidadPerPerson) {
                renderDisponibilidadPerPerson(slots);
            } else {
                renderDisponibilidadPerGroup(slots);
            }

            updateRestrictionSelects();
        }

        // Renderiza Disponibilidad por GRUPO (Tabla)
        function renderDisponibilidadPerGroup(slots) {
            const table = document.getElementById('disponibilidad-table');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');

            thead.innerHTML = '<tr><th>Grupo</th>' + SLOT_HEADERS.map(name => `<th>${name}</th>`).join('') + '</tr>';

            let bodyHTML = '';
            GRUPOS_DATA.forEach(group => {
                const groupId = group.id;
                bodyHTML += `<tr><td style="font-weight: bold; text-align: left;">${group.name}</td>`;

                const currentDisp = disponibilidadMap.get(groupId);
                const isCheckedFunc = (slot) => currentDisp ? currentDisp.has(slot) : true;

                for (let i = 1; i <= slots; i++) {
                    const isChecked = isCheckedFunc(i);
                    bodyHTML += `
                        <td>
                            <input type="checkbox" class="disp-check" 
                                onchange="toggleDisponibilidadItem('${groupId}', ${i}, this.checked, false)" ${isChecked ? 'checked' : ''}>
                        </td>
                    `;
                }
                bodyHTML += '</tr>';
            });
            tbody.innerHTML = bodyHTML;
        }

        // Renderiza Disponibilidad por PERSONA (Lista/Tabla)
        function renderDisponibilidadPerPerson(slots) {
            const listDiv = document.getElementById('disponibilidad-per-person-list');
            listDiv.innerHTML = '';
            getActiveParticipants();

            const slotsHtml = SLOT_HEADERS.map((name, index) =>
                `<th style="writing-mode: vertical-rl; transform: rotate(180deg);">${name}</th>`
            ).join('');

            let tableHTML = `<table style="width: 100%; min-width: max-content;"><thead><tr><th>Persona</th>${slotsHtml}</tr></thead><tbody>`;

            PARTICIPANTES.forEach(person => {
                tableHTML += `<tr><td style="font-weight: bold; text-align: left;">${person}</td>`;

                const currentDisp = disponibilidadMap.get(person);
                const isCheckedFunc = (slot) => currentDisp ? currentDisp.has(slot) : true;

                for (let i = 1; i <= slots; i++) {
                    const isChecked = isCheckedFunc(i);
                    tableHTML += `
                        <td>
                            <input type="checkbox" class="disp-check" 
                                onchange="toggleDisponibilidadItem('${person}', ${i}, this.checked, true)" ${isChecked ? 'checked' : ''}>
                        </td>
                    `;
                }
                tableHTML += '</tr>';
            });

            tableHTML += '</tbody></table>';
            listDiv.innerHTML = tableHTML;
        }


        function toggleDisponibilidadItem(itemId, slot, isChecked, isPerson) {
            if (!disponibilidadMap.has(itemId)) {
                const slots = parseInt(document.getElementById('slots').value);
                const initialSet = new Set();
                for (let i = 1; i <= slots; i++) { initialSet.add(i); }
                disponibilidadMap.set(itemId, initialSet);
            }

            if (isChecked) {
                disponibilidadMap.get(itemId).add(slot);
            } else {
                disponibilidadMap.get(itemId).delete(slot);
            }
        }

        function checkAllSlots() {
            const slots = parseInt(document.getElementById('slots').value);
            const targets = isDisponibilidadPerPerson ? PARTICIPANTES : GRUPOS_DATA.map(g => g.id);

            targets.forEach(target => {
                const targetId = typeof target === 'string' ? target : target.id;
                const availableSlots = new Set();
                for (let i = 1; i <= slots; i++) { availableSlots.add(i); }
                disponibilidadMap.set(targetId, availableSlots);
            });
            loadDisponibilidad();
            showNotification('Disponibilidad marcada para todos.', 'info');
        }


        function renderGroups() {
            // DISE√ëO RESTAURADO
            const listDiv = document.getElementById('group-list');
            listDiv.innerHTML = '';

            getActiveParticipants();
            const isSingleGroup = GRUPOS_DATA.length === 1;

            GRUPOS_DATA.forEach((group) => {
                group.id = group.name.toLowerCase().replace(/\s/g, '_').replace(/[^a-z0-9_]/g, '');
                group.colorClass = `group-${group.id}`;

                const card = document.createElement('div');
                card.className = `group-card`;
                const safeName = group.name.replace(/"/g, '&quot;');

                let headerHTML = '';
                if (!isSingleGroup) {
                    headerHTML = `
                        <div class="flex-row" style="justify-content:space-between;">
                            <input type="text" value="${safeName}" onchange="renameGroup('${group.id}', this.value)" style="font-weight:bold; border:1px solid var(--border-color); background:var(--sub-panel-bg);">
                            <button class="btn-danger btn-small" style="margin-left:auto;" onclick="removeGroup('${group.id}')">Eliminar</button>
                        </div>
                        <label style="font-size: 0.9em; display:block; margin-top: 5px; color: var(--sub-text-color);">Miembros (coma):</label>
                    `;
                } else {
                    headerHTML = `
                        <div class="flex-row" style="justify-content:flex-start;">
                            <h3 style="margin: 0; color: var(--primary-color);">Participantes (Grupo √önico)</h3>
                        </div>
                        <label style="font-size: 0.9em; display:block; margin-top: 5px; color: var(--sub-text-color);">Participantes (coma):</label>
                    `;
                }

                card.innerHTML = `
                    ${headerHTML}
                    <textarea onchange="updateGroupMembers('${group.id}', this.value)">${group.members}</textarea>
                `;
                listDiv.appendChild(card);
            });
            updateRestrictionSelects();
        }

        function renameGroup(oldId, newName) {
            if (GRUPOS_DATA.length === 1) return;
            const group = GRUPOS_DATA.find(g => g.id === oldId);
            if (group) {
                group.name = newName.trim();
                const newId = newName.toLowerCase().replace(/\s/g, '_').replace(/[^a-z0-9_]/g, '');
                group.id = newId;
                group.colorClass = `group-${newId}`;
                renderGroups();
                loadDisponibilidad();
            }
        }

        function updateGroupMembers(id, membersString) {
            const group = GRUPOS_DATA.find(g => g.id === id);
            if (group) {
                group.members = membersString;
                getActiveParticipants();
                updateRestrictionSelects();
                loadDisponibilidad();
            }
        }

        function addGroup() {
            const newNameInput = document.getElementById('new-group-name');
            const name = newNameInput.value.trim() || `Grupo ${GRUPOS_DATA.length + 1}`;
            newNameInput.value = '';

            const newId = name.toLowerCase().replace(/\s/g, '_').replace(/[^a-z0-9_]/g, '');
            GRUPOS_DATA.push({
                id: newId,
                name: name,
                members: '',
                colorClass: `group-${newId}`
            });
            renderGroups();
            loadDisponibilidad();
            showNotification(`Grupo "${name}" a√±adido.`, 'success');
        }

        function removeGroup(id) {
            if (GRUPOS_DATA.length <= 1) {
                showNotification("Debe haber al menos un grupo. No se puede eliminar el grupo √∫nico.", 'error');
                return;
            }
            const groupName = GRUPOS_DATA.find(g => g.id === id)?.name;
            GRUPOS_DATA = GRUPOS_DATA.filter(g => g.id !== id);
            disponibilidadMap.delete(id);
            renderGroups();
            loadDisponibilidad();
            showNotification(`Grupo "${groupName}" eliminado.`, 'info');
        }

        // --- Restricciones y Obligaciones (STAGING) ---
        function updateRestrictionSelects() {
            getActiveParticipants();
            const selects = [document.getElementById('res-p1'), document.getElementById('res-p2'), document.getElementById('obl-p1'), document.getElementById('obl-p2-single-select')];

            selects.forEach(select => {
                select.innerHTML = '<option value="">(Seleccionar)</option>';
                PARTICIPANTES.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p;
                    option.textContent = p;
                    select.appendChild(option);
                });
            });
            renderRestrictions();
            renderObligations();
            checkObligationStagingState();
        }

        // --- Staging de Obligaciones ---
        function getStagedRequiredPeople() {
            const stagingDiv = document.getElementById('required-people-staging');
            return Array.from(stagingDiv.querySelectorAll('.staged-person')).map(div => div.dataset.person);
        }

        function renderStagedRequiredPeople() {
            const stagingDiv = document.getElementById('required-people-staging');
            const stagedPeople = getStagedRequiredPeople();

            stagingDiv.innerHTML = stagedPeople.map(p => `
                <div class="staged-person" data-person="${p}">
                    ${p} 
                    <button onclick="removeStagedPerson('${p}')">x</button>
                </div>
            `).join('');

            checkObligationStagingState();
        }

        function stageRequiredPerson() {
            const requiredPerson = document.getElementById('obl-p2-single-select').value;
            const obligatedPerson = document.getElementById('obl-p1').value;

            if (!requiredPerson) {
                showNotification("Selecciona una persona para a√±adir como requisito.", 'error');
                return;
            }

            if (requiredPerson === obligatedPerson) {
                showNotification("La persona requerida no puede ser la misma que la persona obligada.", 'error');
                return;
            }

            const stagedPeople = getStagedRequiredPeople();
            if (stagedPeople.includes(requiredPerson)) {
                showNotification(`${requiredPerson} ya est√° en la lista de requisitos.`, 'info');
                return;
            }

            const stagingDiv = document.getElementById('required-people-staging');
            const newStagedDiv = document.createElement('div');
            newStagedDiv.className = 'staged-person';
            newStagedDiv.dataset.person = requiredPerson;
            newStagedDiv.innerHTML = `${requiredPerson} <button class="btn-small" onclick="removeStagedPerson('${requiredPerson}')">x</button>`;

            stagingDiv.appendChild(newStagedDiv);
            document.getElementById('obl-p2-single-select').value = "";

            checkObligationStagingState();
            showNotification(`${requiredPerson} a√±adido al staging.`, 'info');
        }

        function removeStagedPerson(personName) {
            const stagingDiv = document.getElementById('required-people-staging');
            const targetDiv = stagingDiv.querySelector(`[data-person="${personName}"]`);
            if (targetDiv) {
                stagingDiv.removeChild(targetDiv);
            }
            checkObligationStagingState();
            showNotification(`${personName} eliminado del staging.`, 'info');
        }

        function checkObligationStagingState() {
            const requiredFor = document.getElementById('obl-p1').value;
            const requiredPeople = getStagedRequiredPeople();
            const btn = document.getElementById('add-obligation-final-btn');

            if (requiredFor && requiredPeople.length > 0) {
                btn.disabled = false;
            } else {
                btn.disabled = true;
            }
        }

        function addObligation() {
            const requiredFor = document.getElementById('obl-p1').value;
            let requiredPeople = getStagedRequiredPeople();

            if (!requiredFor || requiredPeople.length === 0) {
                showNotification("Aseg√∫rate de haber seleccionado P1 y a√±adido requisitos.", 'error');
                return;
            }

            requiredPeople.sort();
            const requiredPeopleStr = requiredPeople.join(',');

            const exists = OBLIGACIONES_DATA.some(o => (o.requiredFor === requiredFor && o.requiredPeople.join(',') === requiredPeopleStr));

            if (!exists) {
                OBLIGACIONES_DATA.push({ requiredFor: requiredFor, requiredPeople: requiredPeople });

                // Limpiar staging despu√©s de a√±adir
                document.getElementById('obl-p1').value = "";
                document.getElementById('required-people-staging').innerHTML = "";

                renderObligations();
                checkObligationStagingState();
                showNotification(`Obligaci√≥n: ${requiredFor} solo si est√° uno de (${requiredPeople.join(', ')}).`, 'success');
            } else {
                showNotification("Esa obligaci√≥n de inclusi√≥n ya existe.", 'info');
            }
        }

        function removeObligation(requiredFor, requiredPeopleStr) {
            const requiredPeople = requiredPeopleStr.split(',').map(p => p.trim());
            requiredPeople.sort();
            const requiredPeopleCheck = requiredPeople.join(',');

            OBLIGACIONES_DATA = OBLIGACIONES_DATA.filter(r =>
                !(r.requiredFor === requiredFor && r.requiredPeople.join(',') === requiredPeopleCheck)
            );
            renderObligations();
            showNotification(`Obligaci√≥n de ${requiredFor} eliminada.`, 'info');
        }

        function renderObligations() {
            const listDiv = document.getElementById('obligation-list');
            listDiv.innerHTML = '';

            if (OBLIGACIONES_DATA.length === 0) {
                listDiv.innerHTML = '<p style="font-size: 0.9em; color: var(--sub-text-color);">No hay obligaciones activas.</p>';
                return;
            }

            OBLIGACIONES_DATA.forEach(r => {
                const requiredList = r.requiredPeople.join(', ');
                const requiredListStringForRemoval = r.requiredPeople.join(',');

                const div = document.createElement('div');
                div.className = 'flex-row';
                div.style.justifyContent = 'space-between';
                div.innerHTML = `
                    <span>ü§ù **${r.requiredFor}** solo si **${requiredList}**</span>
                    <button class="btn-danger btn-small" onclick="removeObligation('${r.requiredFor}', '${requiredListStringForRemoval}')">X</button>
                `;
                listDiv.appendChild(div);
            });
        }

        function renderRestrictions() {
            const listDiv = document.getElementById('restriction-list');
            listDiv.innerHTML = '';

            if (RESTRICCIONES_DATA.length === 0) {
                listDiv.innerHTML = '<p style="font-size: 0.9em; color: var(--sub-text-color);">No hay restricciones activas.</p>';
                return;
            }

            RESTRICCIONES_DATA.forEach(r => {
                const div = document.createElement('div');
                div.className = 'flex-row';
                div.style.justifyContent = 'space-between';
                div.innerHTML = `
                    <span>üõë ${r.p1} **no** con ${r.p2}</span>
                    <button class="btn-danger btn-small" onclick="removeRestriction('${r.p1}', '${r.p2}')">X</button>
                `;
                listDiv.appendChild(div);
            });
        }

        function addRestriction() {
            const p1 = document.getElementById('res-p1').value;
            const p2 = document.getElementById('res-p2').value;

            if (!p1 || !p2 || p1 === p2) {
                showNotification("Selecciona dos personas diferentes para la restricci√≥n.", 'error');
                return;
            }

            const [minP, maxP] = p1 < p2 ? [p1, p2] : [p2, p1];

            const exists = RESTRICCIONES_DATA.some(r => (r.p1 === minP && r.p2 === maxP));

            if (!exists) {
                RESTRICCIONES_DATA.push({ p1: minP, p2: maxP });
                renderRestrictions();
                showNotification(`Restricci√≥n: ${minP} y ${maxP} no estar√°n juntos.`, 'success');
            } else {
                showNotification("Esa restricci√≥n de exclusi√≥n ya existe.", 'info');
            }
        }

        function removeRestriction(p1, p2) {
            const [minP, maxP] = p1 < p2 ? [p1, p2] : [p2, p1];

            RESTRICCIONES_DATA = RESTRICCIONES_DATA.filter(r => !(r.p1 === minP && r.p2 === maxP));
            renderRestrictions();
            showNotification(`Restricci√≥n entre ${minP} y ${maxP} eliminada.`, 'info');
        }

        // --- 3. PERSISTENCIA Y GUARDADO LOCAL/ARCHIVO ---
        function mapToObject(map) {
            const obj = {};
            map.forEach((value, key) => {
                obj[key] = Array.from(value);
            });
            return obj;
        }

        function objectToMap(obj) {
            const map = new Map();
            for (const key in obj) {
                if (obj.hasOwnProperty(key)) {
                    map.set(key, new Set(obj[key]));
                }
            }
            return map;
        }

        function getCurrentConfigurationObject() {
            return {
                grupos: GRUPOS_DATA,
                restricciones: RESTRICCIONES_DATA,
                obligaciones: OBLIGACIONES_DATA,
                slots: document.getElementById('slots').value,
                headers: SLOT_HEADERS,
                disponibilidad: mapToObject(disponibilidadMap),
                isDisponibilidadPerPerson: isDisponibilidadPerPerson,
                opciones: {
                    semanas: document.getElementById('semanas').value,
                    rowMode: currentRowMode,
                    startDate: document.getElementById('start-date').value,
                    frequency: document.getElementById('frequency').value,
                    turnLabel: document.getElementById('turn-label').value,
                    turnFormat: document.getElementById('turn-format').value,
                    timeSlotDays: document.getElementById('time-slot-days').value,
                    timeSlotTimes: document.getElementById('time-slot-times').value,
                    priorityMode: document.getElementById('priority-mode').value,
                    sameGroupOnly: document.getElementById('same-group-only').checked,
                }
            };
        }

        function applyConfiguration(config, sourceName = 'Configuraci√≥n') {
            try {
                GRUPOS_DATA = config.grupos || [];
                RESTRICCIONES_DATA = config.restricciones || [];
                OBLIGACIONES_DATA = (config.obligaciones || []).map(o => ({
                    requiredFor: o.requiredFor,
                    requiredPeople: Array.isArray(o.requiredPeople) ? o.requiredPeople : (o.requiredPeople || '').split(',').map(p => p.trim()).filter(p => p.length > 0).sort()
                }));

                SLOT_HEADERS = config.headers || ["Visitador", "Acompa√±ante 1", "Acompa√±ante 2"];
                disponibilidadMap = objectToMap(config.disponibilidad || {});
                isDisponibilidadPerPerson = config.isDisponibilidadPerPerson || false;

                const opts = config.opciones || {};
                document.getElementById('slots').value = config.slots || 3;
                document.getElementById('semanas').value = opts.semanas || 12;
                document.getElementById('priority-mode').value = opts.priorityMode || 'frecuencia';
                document.getElementById('same-group-only').checked = opts.sameGroupOnly || false;

                currentRowMode = opts.rowMode || 'date';
                document.getElementById('start-date').value = opts.startDate || new Date().toISOString().substring(0, 10);
                document.getElementById('frequency').value = opts.frequency || 7;
                document.getElementById('turn-label').value = opts.turnLabel || 'Turno';
                document.getElementById('turn-format').value = opts.turnFormat || 'numeric';
                document.getElementById('time-slot-days').value = opts.timeSlotDays || 'Lunes, Martes, Mi√©rcoles';
                document.getElementById('time-slot-times').value = opts.timeSlotTimes || '10:00, 17:00';

                const rowButtons = document.querySelectorAll('.tab-button');
                const activeBtn = Array.from(rowButtons).find(btn => btn.textContent.toLowerCase().includes(currentRowMode.replace('_', ' '))) || rowButtons[0];
                changeRowMode(currentRowMode, activeBtn);

                document.getElementById('disp-mode-toggle').checked = isDisponibilidadPerPerson;
                toggleDisponibilidadMode();

                renderGroups();
                renderRestrictions();
                renderObligations();
                getActiveParticipants();

                showNotification(`${sourceName} cargada exitosamente.`, 'success');

            } catch (e) {
                showNotification(`Error al aplicar ${sourceName}. Los datos guardados podr√≠an estar corruptos.`, 'error');
                console.error(e);
            }
        }

        // --- Preset LOCAL STORAGE Functions ---
        function renderPresetsList() {
            const listDiv = document.getElementById('presets-list');
            listDiv.innerHTML = '';
            const presets = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '{}');

            if (Object.keys(presets).length === 0) {
                listDiv.innerHTML = '<li style="justify-content: center; color: var(--sub-text-color);">No hay presets guardados.</li>';
                return;
            }

            for (const name in presets) {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span style="flex-grow: 1;">${name}</span>
                    <div style="display: flex; gap: 5px;">
                        <button class="btn-secondary btn-small" onclick="loadConfiguration('${name}')">Cargar</button>
                        <button class="btn-danger btn-small" onclick="deleteConfiguration('${name}')">Eliminar</button>
                    </div>
                `;
                listDiv.appendChild(li);
            }
        }

        function saveConfiguration() {
            const nameInput = document.getElementById('preset-name-input');
            const name = nameInput.value.trim();

            if (!name) {
                showNotification("Por favor, introduce un nombre para guardar el preset.", 'error');
                return;
            }

            const config = getCurrentConfigurationObject();

            const presets = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '{}');
            presets[name] = config;
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(presets));

            nameInput.value = '';
            renderPresetsList();
            showNotification(`Configuraci√≥n "${name}" guardada en el navegador.`, 'success');
        }

        function loadConfiguration(name) {
            const presets = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '{}');
            const config = presets[name];

            if (!config) {
                showNotification(`No se encontr√≥ el preset "${name}".`, 'error');
                return;
            }
            applyConfiguration(config, `Preset "${name}"`);
        }

        function deleteConfiguration(name) {
            const presets = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '{}');
            if (presets[name]) {
                delete presets[name];
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(presets));
                renderPresetsList();
                showNotification(`Preset "${name}" eliminado.`, 'info');
            }
        }

        function downloadConfiguration() {
            const config = getCurrentConfigurationObject();
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(config, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "cuadrante_config_" + Date.now() + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            showNotification("Configuraci√≥n descargada como archivo JSON.", 'success');
        }

        function uploadConfiguration(event) {
            const file = event.target.files[0];
            if (!file) {
                showNotification("No se seleccion√≥ ning√∫n archivo.", 'info');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const config = JSON.parse(e.target.result);
                    applyConfiguration(config, `Archivo "${file.name}"`);
                } catch (error) {
                    showNotification(`Error: El archivo "${file.name}" no es un JSON de configuraci√≥n v√°lido.`, 'error');
                    console.error("Error al parsear JSON:", error);
                }
            };
            reader.readAsText(file);
        }

        // --- 4. L√ìGICA DE GENERACI√ìN DE FILAS ---

        function generateRowLabels(semanas) {
            const labels = [];

            if (currentRowMode === 'date') {
                const startDateStr = document.getElementById('start-date').value;
                const frequency = parseInt(document.getElementById('frequency').value) || 7;
                const startDate = new Date(startDateStr);

                for (let i = 0; i < semanas; i++) {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + (i * frequency));
                    labels.push({
                        label: currentDate.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                        isDayBreak: false
                    });
                }
            } else if (currentRowMode === 'turn') {
                const labelBase = document.getElementById('turn-label').value.trim() || 'Turno';
                const format = document.getElementById('turn-format').value;

                for (let i = 0; i < semanas; i++) {
                    let suffix = '';
                    if (format === 'numeric') {
                        suffix = i + 1;
                    } else if (format === 'alphabetic') {
                        let tempIndex = i;
                        while (tempIndex >= 0) {
                            suffix = alphabet[tempIndex % 26] + suffix;
                            tempIndex = Math.floor(tempIndex / 26) - 1;
                        }
                    }
                    labels.push({
                        label: `${labelBase} ${suffix}`,
                        isDayBreak: false
                    });
                }
            } else if (currentRowMode === 'time_slots') {
                const daysStr = document.getElementById('time-slot-days').value.trim();
                const timesStr = document.getElementById('time-slot-times').value.trim();

                const days = daysStr.split(',').map(d => d.trim()).filter(d => d.length > 0);
                const times = timesStr.split(',').map(t => t.trim()).filter(t => t.length > 0);

                if (days.length === 0 || times.length === 0) {
                    showNotification("Define D√≠as y Tramos Horarios para el Modo Tramos.", 'error');
                    return [];
                }

                const totalRows = days.length * times.length;
                let actualRows = 0;
                let dayIndex = 0;

                while (actualRows < semanas) {
                    const dayLabel = days[dayIndex % days.length];

                    for (const timeLabel of times) {
                        if (actualRows < semanas) {
                            labels.push({
                                label: `${dayLabel} - ${timeLabel}`,
                                isDayBreak: actualRows > 0 && (times.indexOf(timeLabel) === 0)
                            });
                            actualRows++;
                        }
                    }
                    dayIndex++;
                }
            }
            return labels.slice(0, semanas);
        }

        // --- 5. L√ìGICA DE ASIGNACI√ìN ---

        /** Comprueba si un item (grupo o persona) es elegible para un slot basado en el modo de disponibilidad. */
        function isSlotAvailable(itemId, slotIndex) {
            return disponibilidadMap.get(itemId)?.has(slotIndex) ?? true;
        }

        function getNextGroupCandidates(slots) {
            const allGroups = GRUPOS_DATA.map(g => g.id);
            const availableGroups = allGroups.filter(groupId => {
                const members = grupoVisitas.get(groupId)?.members || 0;
                if (members === 0) return false;

                if (!isDisponibilidadPerPerson) {
                    for (let i = 1; i <= slots; i++) {
                        if (isSlotAvailable(groupId, i)) return true;
                    }
                } else {
                    const groupMembers = PARTICIPANTES.filter(p => PARTICIPANTES_MAP.get(p)?.groupId === groupId);
                    for (const member of groupMembers) {
                        for (let i = 1; i <= slots; i++) {
                            if (isSlotAvailable(member, i)) return true;
                        }
                    }
                }
                return false;
            });

            availableGroups.sort((id1, id2) => {
                const data1 = grupoVisitas.get(id1) || { count: 0, members: 1 };
                const data2 = grupoVisitas.get(id2) || { count: 0, members: 1 };
                const freq1 = data1.count / data1.members;
                const freq2 = data2.count / data2.members;
                return freq1 - freq2;
            });

            return availableGroups;
        }

        function asignarSlot(slot, personasAsignadasEstaSemana, grupoMiembros, priorityMode, slotIndex) {
            const requiredForPeople = OBLIGACIONES_DATA.map(o => o.requiredFor);

            let candidatos = grupoMiembros.filter(p =>
                !personasAsignadasEstaSemana.has(p)
            );

            candidatos.sort((p1, p2) => {
                const visitas1 = contadorVisitas.get(p1) || 0;
                const visitas2 = contadorVisitas.get(p2) || 0;
                const tiempoSinIr1 = semanaActual - (ultimaVisita.get(p1) || -1);
                const tiempoSinIr2 = semanaActual - (ultimaVisita.get(p2) || -1);

                let p1Repeats = false;
                let p2Repeats = false;

                for (const pAsignado of personasAsignadasEstaSemana) {
                    if (ultimaPareja.get(p1) === pAsignado) p1Repeats = true;
                    if (ultimaPareja.get(p2) === pAsignado) p2Repeats = true;
                }

                if (priorityMode === 'pareja') {
                    if (p1Repeats !== p2Repeats) {
                        return p1Repeats ? 1 : -1;
                    }
                }

                const diffVisitas = visitas1 - visitas2;
                if (diffVisitas !== 0) return diffVisitas;

                return tiempoSinIr2 - tiempoSinIr1;
            });

            const candidatosValidos = [];

            for (const c of candidatos) {
                let isValid = true;
                const isRequiredForPerson = requiredForPeople.includes(c);

                if (isDisponibilidadPerPerson && !isSlotAvailable(c, slotIndex)) {
                    isValid = false;
                }

                // 1. Verificar Restricciones de Exclusi√≥n (No con P2)
                for (const p of personasAsignadasEstaSemana) {
                    RESTRICCIONES_DATA.forEach(r => {
                        if ((r.p1 === c && r.p2 === p) || (r.p2 === c && r.p1 === p)) {
                            isValid = false;
                        }
                    });
                }

                // 2. Verificar Obligaci√≥n de Inclusi√≥n (P1 solo si P2, P3...)
                if (isRequiredForPerson) {
                    const obligacion = OBLIGACIONES_DATA.find(o => o.requiredFor === c);

                    if (personasAsignadasEstaSemana.size === 0) {
                        isValid = true; // El primer slot no tiene requisitos de inclusi√≥n de otros
                    } else {
                        // Comprobar si al menos una persona requerida ya est√° asignada
                        const requiredSet = new Set(obligacion.requiredPeople);
                        const isConditionMet = Array.from(requiredSet).some(p => personasAsignadasEstaSemana.has(p));

                        if (!isConditionMet) {
                            isValid = false;
                        }
                    }
                }

                if (isValid) {
                    candidatosValidos.push(c);
                }
            }

            // PRIORIDAD EXTRA: Asignar a una persona requerida si una persona obligada (P1) ya fue asignada.
            const obligadosAsignados = Array.from(personasAsignadasEstaSemana).filter(p => requiredForPeople.includes(p));

            if (obligadosAsignados.length > 0) {
                const requiredButNotAssigned = new Set();
                obligadosAsignados.forEach(obligado => {
                    const obligacion = OBLIGACIONES_DATA.find(o => o.requiredFor === obligado);
                    obligacion.requiredPeople.forEach(requiredP => {
                        if (!personasAsignadasEstaSemana.has(requiredP)) {
                            requiredButNotAssigned.add(requiredP);
                        }
                    });
                });

                const boostCandidates = candidatosValidos.filter(c => requiredButNotAssigned.has(c));

                if (boostCandidates.length > 0) {
                    const bestRequired = boostCandidates.sort((p1, p2) => {
                        const visitas1 = contadorVisitas.get(p1) || 0;
                        const visitas2 = contadorVisitas.get(p2) || 0;
                        return visitas1 - visitas2;
                    })[0];

                    return { person: bestRequired, groupId: PARTICIPANTES_MAP.get(bestRequired).groupId, isObligationHelper: true };
                }
            }


            const assignedPerson = candidatosValidos[0];
            if (assignedPerson) {
                return { person: assignedPerson, groupId: PARTICIPANTES_MAP.get(assignedPerson).groupId };
            } else {
                return { person: 'VAC√çO', groupId: 'empty' };
            }
        }


        function generarCuadrante() {
            inicializarDatos();

            const semanasTotales = parseInt(document.getElementById('semanas').value);
            const slots = parseInt(document.getElementById('slots').value);
            const priorityMode = document.getElementById('priority-mode').value;
            const sameGroupOnly = document.getElementById('same-group-only').checked;
            const requiredForPeople = new Set(OBLIGACIONES_DATA.map(o => o.requiredFor));

            if (isNaN(semanasTotales) || semanasTotales <= 0 || isNaN(slots) || slots <= 0 || PARTICIPANTES.length < slots) {
                showNotification("Revisa la configuraci√≥n: Filas, slots y aseg√∫rate de tener m√°s miembros que slots.", 'error');
                return;
            }

            const rowLabels = generateRowLabels(semanasTotales);
            if (rowLabels.length === 0) return;

            showNotification("Generando cuadrante...", 'info');

            const cuadrante = [];
            let conflictoDuplicidad = false;

            for (let i = 0; i < semanasTotales; i++) {
                semanaActual++;
                const { label: etiquetaTiempo, isDayBreak } = rowLabels[i];

                const semanaSlots = [];
                let personasAsignadasEstaSemana = new Set();
                let personasAsignadasDuplicadas = new Set();
                let currentAssignedGroup = null;

                const allGroupCandidates = getNextGroupCandidates(slots);

                if (allGroupCandidates.length === 0) {
                    cuadrante.push({ etiquetaTiempo: etiquetaTiempo, slots: Array(slots).fill({ person: 'VAC√çO', groupId: 'empty' }), conflictos: [], isDayBreak: isDayBreak });
                    continue;
                }

                for (let slotIndex = 1; slotIndex <= slots; slotIndex++) {

                    let bestAssigned = { person: 'VAC√çO', groupId: 'empty' };

                    let candidateGroups = [];
                    if (sameGroupOnly && currentAssignedGroup) {
                        candidateGroups = [currentAssignedGroup];
                    } else {
                        candidateGroups = allGroupCandidates;
                    }

                    let foundAssignment = false;
                    for (const groupId of candidateGroups) {

                        // FILTRO DE DISPONIBILIDAD POR GRUPO 
                        if (!isDisponibilidadPerPerson && !(isSlotAvailable(groupId, slotIndex))) {
                            if (sameGroupOnly && currentAssignedGroup) {
                                bestAssigned = { person: 'VAC√çO', groupId: 'empty' };
                                break;
                            }
                            continue;
                        }

                        const grupoMiembros = PARTICIPANTES.filter(p => PARTICIPANTES_MAP.get(p)?.groupId === groupId);
                        const asignacion = asignarSlot(slotIndex, personasAsignadasEstaSemana, grupoMiembros, priorityMode, slotIndex);

                        if (asignacion.person !== 'VAC√çO') {

                            // EXCEPCI√ìN: Si se asigna una persona con obligaci√≥n (P1)
                            const assignedIsRequired = requiredForPeople.has(asignacion.person);

                            if (sameGroupOnly && currentAssignedGroup && currentAssignedGroup !== asignacion.groupId && !assignedIsRequired) {
                                continue;
                            }

                            bestAssigned = { person: asignacion.person, groupId: asignacion.groupId };

                            if (sameGroupOnly && !currentAssignedGroup) {
                                currentAssignedGroup = asignacion.groupId;
                            }

                            // Si el asignado es una persona con obligaci√≥n activa (P1), NO FIJA EL GRUPO para slots posteriores.
                            if (sameGroupOnly && assignedIsRequired) {
                                // Mantenemos el currentAssignedGroup si ya existe,
                                // pero no lo actualizamos al grupo del obligado para no restringir a los dem√°s slots.
                            }


                            foundAssignment = true;
                            break;
                        }

                        if (sameGroupOnly && currentAssignedGroup && groupId === currentAssignedGroup) {
                            bestAssigned = { person: 'VAC√çO', groupId: 'empty' };
                            break;
                        }
                    }

                    semanaSlots.push(bestAssigned);

                    if (bestAssigned.person !== 'VAC√çO') {

                        if (personasAsignadasEstaSemana.has(bestAssigned.person)) {
                            conflictoDuplicidad = true;
                            personasAsignadasDuplicadas.add(bestAssigned.person);
                        } else {
                            personasAsignadasEstaSemana.add(bestAssigned.person);

                            contadorVisitas.set(bestAssigned.person, (contadorVisitas.get(bestAssigned.person) || 0) + 1);
                            ultimaVisita.set(bestAssigned.person, semanaActual);

                            const currentGroupData = grupoVisitas.get(bestAssigned.groupId);
                            if (currentGroupData) {
                                grupoVisitas.set(bestAssigned.groupId, { ...currentGroupData, count: currentGroupData.count + 1 });
                            }
                        }
                    }

                    if (sameGroupOnly && bestAssigned.person === 'VAC√çO') {
                        // Si no encontramos a nadie para el grupo actual, y sameGroupOnly est√° activo, los slots restantes quedan VAC√çO
                        for (let k = slotIndex + 1; k <= slots; k++) { semanaSlots.push({ person: 'VAC√çO', groupId: 'empty' }); }
                        break;
                    }
                }

                const asignados = [...personasAsignadasEstaSemana].filter(p => p !== 'VAC√çO');
                if (asignados.length > 1) {
                    for (let i = 0; i < asignados.length; i++) {
                        for (let j = i + 1; j < asignados.length; j++) {
                            ultimaPareja.set(asignados[i], asignados[j]);
                            ultimaPareja.set(asignados[j], asignados[i]);
                        }
                    }
                }

                cuadrante.push({ etiquetaTiempo: etiquetaTiempo, slots: semanaSlots, conflictos: [...personasAsignadasDuplicadas], isDayBreak: isDayBreak });
            }

            ULTIMO_CUADRANTE_GENERADO = cuadrante;
            mostrarResultados(cuadrante);

            if (conflictoDuplicidad) {
                showNotification("‚ö†Ô∏è **ERROR:** Se encontraron personas asignadas a dos o m√°s slots en la misma fila (duplicidad). Los conflictos est√°n marcados en **rojo**.", 'error');
            } else {
                showNotification("‚úÖ Cuadrante generado con √©xito.", 'success');
            }
        }

        // --- 6. RENDERIZACI√ìN DE RESULTADOS ---
        function updateTableWidth() {
            const range = document.getElementById('table-width-range');
            const tableContainer = document.getElementById('cuadrante-table-container');
            const tableWidthValue = document.getElementById('table-width-value');
            if (tableContainer && range) {
                const table = tableContainer.querySelector('table');
                table.style.width = `${range.value}%`;
                tableWidthValue.textContent = `${range.value}%`;
                localStorage.setItem('table-width', range.value);
            }
        }

        function mostrarResultados(cuadrante) {
            const resultadosDiv = document.getElementById('resultados');
            const totalCols = SLOT_HEADERS.length + 1;

            // T√≠tulo de la tabla y control de ancho
            let headerControlsHTML = `
                <input type="text" id="cuadrante-title-input" value="Cuadrante Generado - ${new Date().toLocaleDateString('es-ES')}" style="width: 100%; font-size: 1.2em; font-weight: bold; margin-top: 20px; padding: 5px; background: transparent; border: 1px solid var(--border-color); color: var(--text-color);">
                <div class="width-control-bar">
                    <label for="table-width-range" style="font-weight: bold; min-width: 150px;">Ancho de Tabla (en %):</label>
                    <input type="range" id="table-width-range" min="50" max="200" value="${localStorage.getItem('table-width') || 100}" oninput="updateTableWidth()">
                    <span id="table-width-value">${localStorage.getItem('table-width') || 100}%</span>
                </div>
            `;

            let tablaHTML = `<div id='cuadrante-table-container'><table><thead>`;

            // Fila de T√≠tulo del Cuadrante (Colspan)
            tablaHTML += `<tr><th colspan="${totalCols}" class="cuadrante-title-cell" id="final-cuadrante-title"></th></tr>`;

            // Fila de Encabezados de Columna
            tablaHTML += `<tr><th>${currentRowMode === 'time_slots' ? 'D√≠a/Hora' : 'Fila'}</th>`;
            SLOT_HEADERS.forEach(header => {
                tablaHTML += `<th>${header}</th>`;
            });
            tablaHTML += "</tr></thead><tbody>";

            cuadrante.forEach(fila => {
                const dayBreakClass = fila.isDayBreak ? 'day-break' : '';
                tablaHTML += `<tr class="${dayBreakClass}"><td style="font-weight: bold; text-align: left;">${fila.etiquetaTiempo}</td>`;

                fila.slots.forEach(slot => {
                    let cellClass = "";
                    const conflictosSet = new Set(fila.conflictos || []);

                    if (conflictosSet.has(slot.person)) {
                        cellClass = "conflict_cell_colored";
                    }

                    tablaHTML += `<td class="${cellClass}">${slot.person}</td>`;
                });
                tablaHTML += "</tr>";
            });

            tablaHTML += "</tbody></table></div>";

            // Resumen de Frecuencia AGRUPADO (Texto "Distribuci√≥n por Frecuencia de Turnos" eliminado)
            let resumenHTML = "<div class='resumen' style='margin-top: 20px;'><h3>Resumen de Frecuencia (Turnos Totales)</h3>";

            const resumenVisitas = Array.from(contadorVisitas.entries())
                .filter(([, v]) => v > 0)
                .sort(([, v1], [, v2]) => v2 - v1);

            const turnosAgrupados = resumenVisitas.reduce((acc, [nombre, turnos]) => {
                if (!acc[turnos]) acc[turnos] = [];
                acc[turnos].push(nombre);
                return acc;
            }, {});

            const turnosOrdenados = Object.keys(turnosAgrupados).sort((a, b) => b - a);

            resumenHTML += "<div style='margin-top: 15px;'>"; // Eliminado el h4
            resumenHTML += "<ul>";

            turnosOrdenados.forEach(turnos => {
                const personas = turnosAgrupados[turnos].join(', ');
                resumenHTML += `<li><strong>${turnos} turnos:</strong> ${personas}</li>`;
            });

            resumenHTML += "</ul></div></div>";

            resultadosDiv.innerHTML = headerControlsHTML + tablaHTML + resumenHTML;

            const titleInput = document.getElementById('cuadrante-title-input');
            const finalTitle = document.getElementById('final-cuadrante-title');

            finalTitle.textContent = titleInput.value;
            titleInput.addEventListener('input', (e) => {
                finalTitle.textContent = e.target.value;
            });

            document.getElementById('table-width-range').addEventListener('input', updateTableWidth);
            updateTableWidth();
        }

        // --- INICIALIZACI√ìN ---
        window.onload = () => {
            const savedMode = localStorage.getItem('dark-mode') === 'true';
            document.getElementById('dark-mode-toggle').checked = savedMode;
            document.body.classList.toggle('dark-mode', savedMode);

            renderGroups();

            const savedRowMode = localStorage.getItem('row-mode') || 'date';
            const rowButtons = document.querySelectorAll('.tab-button');
            const activeBtn = Array.from(rowButtons).find(btn => btn.textContent.toLowerCase().includes(savedRowMode.replace('_', ' '))) || rowButtons[0];
            changeRowMode(savedRowMode, activeBtn);

            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            document.getElementById('start-date').value = `${year}-${month}-${day}`;

            const initialDispMode = localStorage.getItem('disp-mode') === 'per-person';
            document.getElementById('disp-mode-toggle').checked = initialDispMode;
            isDisponibilidadPerPerson = initialDispMode;

            loadDisponibilidad();
            toggleDisponibilidadMode();
            renderPresetsList();

            document.getElementById('obl-p1').addEventListener('change', checkObligationStagingState);

            showNotification("‚úÖ Mejoras de scroll y est√©tica aplicadas.", 'success');
        };
    </script>

</body>

</html>